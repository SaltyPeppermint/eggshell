use egg::{
    Applier, EGraph, Id, Language, PatternAst, RecExpr, Rewrite, Subst, Symbol, Var, rewrite,
};

use crate::rewrite_system::rise::kind::Kindable;

use super::func::{NotFreeIn, VectorizeScalarFun, pat};
use super::nat::ComputeNatCheck;
use super::shifted::{Shifted, ShiftedCheck, shift_mut};
use super::{DBIndex, DBShift, Kind, Rise, RiseAnalysis};

pub fn mm_rules() -> Vec<Rewrite<Rise, RiseAnalysis>> {
    let mut algorithmic = vec![
        rewrite!("eta-reduction"; "(typeOf (lam (typeOf (app (typeOf ?0 ?tAny0) (typeOf %e0 ?t0)) ?tAny1)) (fun ?t1 ?t2))" => { NotFreeIn::new("?0", 0, Shifted::new("?0", "?1", -1, 1, ShiftedCheck::new("?t1", "?t0", 1, 0, pat("(typeOf ?1 (fun ?t1 ?t2))")))) }),
        rewrite!("map-fission"; "(typeOf (app (typeOf map ?tAny2) (typeOf (lam (typeOf (app (typeOf ?0 ?tAny3) (typeOf ?1 ?dt0)) ?tAny4)) (fun ?dt1 ?dt2))) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt2)))" => { NotFreeIn::new("?0", 0, Shifted::new("?1", "?2", 1, 1, Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt1", "?dt4", 1, 0, Shifted::new("?dt2", "?dt3", 1, 0, Shifted::new("?dt0", "?dt5", 1, 1, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun ?dt0 ?dt3) (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt3)))) (typeOf ?0 (fun ?dt0 ?dt3))) (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt3))) (typeOf (app (typeOf (app (typeOf map (fun (fun ?dt4 ?dt0) (fun (arrT ?n1 ?dt4) (arrT ?n1 ?dt0)))) (typeOf (lam (typeOf ?2 ?dt5)) (fun ?dt4 ?dt0))) (fun (arrT ?n1 ?dt4) (arrT ?n1 ?dt0))) (typeOf %e0 (arrT ?n1 ?dt4))) (arrT ?n1 ?dt0))) (arrT ?n1 ?dt3))) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt2)))"))))))) }),
        rewrite!("reduce-seq"; "(typeOf reduce (fun (fun ?dt0 (fun ?dt0 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt0) ?dt0))))" => { pat("(typeOf reduceSeq (fun (fun ?dt0 (fun ?dt0 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt0) ?dt0))))") }),
        rewrite!("eliminate-map-identity"; "(typeOf (app (typeOf map ?tAny5) (typeOf (lam (typeOf %e0 ?tAny6)) (fun ?dt0 ?dt0))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0)))" => { Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt0", "?dt1", 1, 0, pat("(typeOf (lam (typeOf %e0 (arrT ?n1 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0)))"))) }),
        rewrite!("reduce-seq-map-fusion"; "(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?tAny7) (typeOf ?0 (fun ?dt0 (fun ?dt1 ?dt0)))) ?tAny8) (typeOf ?1 ?dt0)) ?tAny9) (typeOf (app (typeOf (app (typeOf map ?tAny10) (typeOf ?2 (fun ?dt2 ?dt1))) ?tAny11) (typeOf ?3 (arrT ?n0 ?dt2))) (arrT ?n0 ?dt1))) ?dt0)" => { Shifted::new("?2", "?5", 2, 0, Shifted::new("?0", "?4", 2, 0, Shifted::new("?dt0", "?dt3", 2, 0, Shifted::new("?dt0", "?dt7", 1, 0, Shifted::new("?dt2", "?dt5", 2, 0, Shifted::new("?dt2", "?dt6", 1, 0, Shifted::new("?dt1", "?dt4", 2, 0, pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun ?dt0 (fun ?dt2 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt2) ?dt0)))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?4 (fun ?dt3 (fun ?dt4 ?dt3))) (typeOf %e1 ?dt3)) (fun ?dt4 ?dt3)) (typeOf (app (typeOf ?5 (fun ?dt5 ?dt4)) (typeOf %e0 ?dt5)) ?dt4)) ?dt3)) (fun ?dt6 ?dt7))) (fun ?dt0 (fun ?dt2 ?dt0)))) (fun ?dt0 (fun (arrT ?n0 ?dt2) ?dt0))) (typeOf ?1 ?dt0)) (fun (arrT ?n0 ?dt2) ?dt0)) (typeOf ?3 (arrT ?n0 ?dt2))) ?dt0)")))))))) }),
        rewrite!("split-join-32"; "(typeOf (app (typeOf (app (typeOf map ?tAny12) (typeOf ?0 (fun ?dt0 ?dt1))) ?tAny13) (typeOf ?1 (arrT ?n0 ?dt0))) (arrT ?n0 ?dt1))" => { Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt0", "?dt2", 1, 0, pat("(typeOf (app (typeOf join (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)) (arrT ?n0 ?dt1))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT 32 ?dt0) (arrT 32 ?dt1)) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (typeOf ?0 (fun ?dt0 ?dt1))) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (typeOf (app (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 (natMul (natPow 32 -1) ?n1)) ?dt2) (arrT (natMul (natPow 32 -1) ?n1) (arrT %n0 ?dt2))))) 32) (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (typeOf ?1 (arrT ?n0 ?dt0))) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (arrT ?n0 ?dt1))"))) }),
        rewrite!("split-join-2m-32"; "(typeOf (app (typeOf (app (typeOf map ?tAny14) (typeOf (app (typeOf map ?tAny15) (typeOf (app (typeOf map ?tAny16) (typeOf ?0 (fun ?dt0 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT ?n0 ?dt1))))) ?tAny17) (typeOf ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))" => { Shifted::new("?n0", "?n3", 1, 0, Shifted::new("?dt0", "?dt2", 1, 0, pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1)))))) (typeOf (app (typeOf map (fun (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)) (arrT ?n0 ?dt1)) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf join (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)) (arrT ?n0 ?dt1)))) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))))) (typeOf (app (typeOf map (fun (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (typeOf (app (typeOf map (fun (fun (arrT 32 ?dt0) (arrT 32 ?dt1)) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (typeOf ?0 (fun ?dt0 ?dt1))) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))))))) (typeOf (app (typeOf map (fun (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 (natMul (natPow 32 -1) ?n3)) ?dt2) (arrT (natMul (natPow 32 -1) ?n3) (arrT %n0 ?dt2))))) 32) (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (typeOf ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))"))) }),
        rewrite!("blocked-reduce-4"; "(typeOf (app (typeOf (app (typeOf (app (typeOf reduce ?tAny18) (typeOf ?0 (fun ?dt0 (fun ?dt0 ?dt0)))) ?tAny19) (typeOf ?1 ?dt0)) ?tAny20) (typeOf ?2 (arrT ?n0 ?dt0))) ?dt0)" => { Shifted::new("?1", "?4", 2, 0, Shifted::new("?0", "?3", 2, 0, Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt0", "?dt1", 2, 0, Shifted::new("?dt0", "?dt2", 1, 0, pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun ?dt0 (fun (arrT 4 ?dt0) ?dt0)) (fun ?dt0 (fun (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)) ?dt0)))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?3 (fun ?dt1 (fun ?dt1 ?dt1))) (typeOf %e1 ?dt1)) (fun ?dt1 ?dt1)) (typeOf (app (typeOf (app (typeOf (app (typeOf reduce (fun (fun ?dt1 (fun ?dt1 ?dt1)) (fun ?dt1 (fun (arrT 4 ?dt1) ?dt1)))) (typeOf ?3 (fun ?dt1 (fun ?dt1 ?dt1)))) (fun ?dt1 (fun (arrT 4 ?dt1) ?dt1))) (typeOf ?4 ?dt1)) (fun (arrT 4 ?dt1) ?dt1)) (typeOf %e0 (arrT 4 ?dt1))) ?dt1)) ?dt1)) (fun (arrT 4 ?dt2) ?dt2))) (fun ?dt0 (fun (arrT 4 ?dt0) ?dt0)))) (fun ?dt0 (fun (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)) ?dt0))) (typeOf ?1 ?dt0)) (fun (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)) ?dt0)) (typeOf (app (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 (natMul (natPow 4 -1) ?n1)) ?dt2) (arrT (natMul (natPow 4 -1) ?n1) (arrT %n0 ?dt2))))) 4) (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)))) (typeOf ?2 (arrT ?n0 ?dt0))) (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)))) ?dt0)")))))) }),
        rewrite!("split-before-map"; "(typeOf (app (typeOf (natApp (typeOf split ?tAny21) ?n0) ?tAny22) (typeOf (app (typeOf (app (typeOf map ?tAny23) (typeOf ?0 (fun ?dt0 ?dt1))) ?tAny24) (typeOf ?1 (arrT ?n1 ?dt0))) (arrT ?n2 ?dt1))) (arrT ?n3 (arrT ?n0 ?dt1)))" => { Shifted::new("?n3", "?n4", 1, 0, Shifted::new("?dt0", "?dt2", 1, 0, ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)) (fun (arrT ?n3 (arrT ?n0 ?dt0)) (arrT ?n3 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) (typeOf ?0 (fun ?dt0 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) (fun (arrT ?n3 (arrT ?n0 ?dt0)) (arrT ?n3 (arrT ?n0 ?dt1)))) (typeOf (app (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 ?n4) ?dt2) (arrT ?n4 (arrT %n0 ?dt2))))) ?n0) (fun (arrT (natMul ?n3 ?n0) ?dt0) (arrT ?n3 (arrT ?n0 ?dt0)))) (typeOf ?1 (arrT (natMul ?n3 ?n0) ?dt0))) (arrT ?n3 (arrT ?n0 ?dt0)))) (arrT ?n3 (arrT ?n0 ?dt1)))"))))) }),
        rewrite!("reduce-seq-map-fission"; "(typeOf (app (typeOf (app (typeOf reduceSeq ?tAny25) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?0 ?tAny26) (typeOf %e1 ?dt0)) ?tAny27) (typeOf ?1 ?dt1)) ?tAny28)) ?tAny29)) (fun ?dt2 (fun ?dt3 ?dt2)))) ?tAny30) (typeOf ?2 ?dt2)) (fun (arrT ?n0 ?dt3) ?dt2))" => { NotFreeIn::new("?0", 0, Shifted::new("?2", "?4", 1, 0, Shifted::new("?0", "?3", -1, 2, Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt3", "?dt6", 1, 0, ShiftedCheck::new("?dt2", "?dt0", 2, 0, Shifted::new("?dt2", "?dt4", 1, 0, Shifted::new("?dt1", "?dt5", -1, 2, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun ?dt4 (fun ?dt5 ?dt4)) (fun ?dt4 (fun (arrT ?n1 ?dt5) ?dt4)))) (typeOf ?3 (fun ?dt4 (fun ?dt5 ?dt4)))) (fun ?dt4 (fun (arrT ?n1 ?dt5) ?dt4))) (typeOf ?4 ?dt4)) (fun (arrT ?n1 ?dt5) ?dt4)) (typeOf (app (typeOf (app (typeOf map (fun (fun ?dt6 ?dt5) (fun (arrT ?n1 ?dt6) (arrT ?n1 ?dt5)))) (typeOf (lam (typeOf ?1 ?dt1)) (fun ?dt6 ?dt5))) (fun (arrT ?n1 ?dt6) (arrT ?n1 ?dt5))) (typeOf %e0 (arrT ?n1 ?dt6))) (arrT ?n1 ?dt5))) ?dt4)) (fun (arrT ?n0 ?dt3) ?dt2))"))))))))) }),
        rewrite!("lift-reduce-seq"; "(typeOf (app (typeOf map ?tAny31) (typeOf (app (typeOf (app (typeOf reduceSeq ?tAny32) (typeOf ?0 (fun ?dt0 (fun ?dt1 ?dt0)))) ?tAny33) (typeOf ?1 ?dt0)) (fun (arrT ?n0 ?dt1) ?dt0))) (fun (arrT ?n1 (arrT ?n0 ?dt1)) (arrT ?n1 ?dt0)))" => { Shifted::new("?1", "?3", 2, 0, Shifted::new("?0", "?2", 4, 0, Shifted::new("?n1", "?n4", 3, 0, Shifted::new("?n1", "?n5", 2, 0, Shifted::new("?n1", "?n2", 1, 0, Shifted::new("?n0", "?n3", 1, 0, Shifted::new("?dt1", "?dt7", 4, 0, Shifted::new("?dt1", "?dt5", 3, 0, Shifted::new("?dt1", "?dt8", 2, 0, Shifted::new("?dt1", "?dt3", 1, 0, Shifted::new("?dt0", "?dt6", 4, 0, Shifted::new("?dt0", "?dt4", 3, 0, Shifted::new("?dt0", "?dt9", 2, 0, Shifted::new("?dt0", "?dt2", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun (arrT ?n2 ?dt2) (fun (arrT ?n2 ?dt3) (arrT ?n2 ?dt2))) (fun (arrT ?n2 ?dt2) (fun (arrT ?n3 (arrT ?n2 ?dt3)) (arrT ?n2 ?dt2))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun (pairT ?dt4 ?dt5) ?dt4) (fun (arrT ?n4 (pairT ?dt4 ?dt5)) (arrT ?n4 ?dt4)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?2 (fun ?dt6 (fun ?dt7 ?dt6))) (typeOf (app (typeOf fst (fun (pairT ?dt6 ?dt7) ?dt6)) (typeOf %e0 (pairT ?dt6 ?dt7))) ?dt6)) (fun ?dt7 ?dt6)) (typeOf (app (typeOf snd (fun (pairT ?dt6 ?dt7) ?dt7)) (typeOf %e0 (pairT ?dt6 ?dt7))) ?dt7)) ?dt6)) (fun (pairT ?dt4 ?dt5) ?dt4))) (fun (arrT ?n4 (pairT ?dt4 ?dt5)) (arrT ?n4 ?dt4))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n4 ?dt4) (fun (arrT ?n4 ?dt5) (arrT ?n4 (pairT ?dt4 ?dt5))))) (typeOf %e1 (arrT ?n4 ?dt4))) (fun (arrT ?n4 ?dt5) (arrT ?n4 (pairT ?dt4 ?dt5)))) (typeOf %e0 (arrT ?n4 ?dt5))) (arrT ?n4 (pairT ?dt4 ?dt5)))) (arrT ?n4 ?dt4))) (fun (arrT ?n5 ?dt8) (arrT ?n5 ?dt9)))) (fun (arrT ?n2 ?dt2) (fun (arrT ?n2 ?dt3) (arrT ?n2 ?dt2))))) (fun (arrT ?n2 ?dt2) (fun (arrT ?n3 (arrT ?n2 ?dt3)) (arrT ?n2 ?dt2)))) (typeOf (app (typeOf generate (fun (fun (idxT ?n2) ?dt2) (arrT ?n2 ?dt2))) (typeOf (lam (typeOf ?3 ?dt9)) (fun (idxT ?n2) ?dt2))) (arrT ?n2 ?dt2))) (fun (arrT ?n3 (arrT ?n2 ?dt3)) (arrT ?n2 ?dt2))) (typeOf (app (typeOf transpose (fun (arrT ?n2 (arrT ?n3 ?dt3)) (arrT ?n3 (arrT ?n2 ?dt3)))) (typeOf %e0 (arrT ?n2 (arrT ?n3 ?dt3)))) (arrT ?n3 (arrT ?n2 ?dt3)))) (arrT ?n2 ?dt2))) (fun (arrT ?n1 (arrT ?n0 ?dt1)) (arrT ?n1 ?dt0)))"))))))))))))))) }),
        rewrite!("lift-reduce-seq-2"; "(typeOf (app (typeOf map ?tAny34) (typeOf (lam (typeOf (app (typeOf (app (typeOf add ?tAny35) (typeOf (app (typeOf fst ?tAny36) (typeOf %e0 (pairT f32 (arrT ?n0 ?dt0)))) f32)) ?tAny37) (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?tAny38) (typeOf ?0 (fun f32 (fun ?dt0 f32)))) ?tAny39) (typeOf 0.0 f32)) ?tAny40) (typeOf (app (typeOf snd ?tAny41) (typeOf %e0 (pairT f32 (arrT ?n0 ?dt0)))) (arrT ?n0 ?dt0))) f32)) ?tAny42)) (fun (pairT f32 (arrT ?n1 ?dt1)) f32))) (fun (arrT ?n2 (pairT f32 (arrT ?n1 ?dt1))) (arrT ?n2 f32)))" => { Shifted::new("?0", "?1", 4, 1, Shifted::new("?n2", "?n5", 4, 0, Shifted::new("?n2", "?n6", 3, 0, Shifted::new("?n2", "?n3", 2, 0, Shifted::new("?n2", "?n7", 1, 0, Shifted::new("?n1", "?n4", 2, 0, ShiftedCheck::new("?n1", "?n0", 1, 0, Shifted::new("?dt1", "?dt4", 5, 0, Shifted::new("?dt1", "?dt3", 4, 0, Shifted::new("?dt1", "?dt5", 3, 0, Shifted::new("?dt1", "?dt2", 2, 0, ShiftedCheck::new("?dt1", "?dt0", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun (arrT ?n3 f32) (fun (arrT ?n3 ?dt2) (arrT ?n3 f32))) (fun (arrT ?n3 f32) (fun (arrT ?n4 (arrT ?n3 ?dt2)) (arrT ?n3 f32))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun (pairT f32 ?dt3) f32) (fun (arrT ?n5 (pairT f32 ?dt3)) (arrT ?n5 f32)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?1 (fun f32 (fun ?dt4 f32))) (typeOf (app (typeOf fst (fun (pairT f32 ?dt4) f32)) (typeOf %e0 (pairT f32 ?dt4))) f32)) (fun ?dt4 f32)) (typeOf (app (typeOf snd (fun (pairT f32 ?dt4) ?dt4)) (typeOf %e0 (pairT f32 ?dt4))) ?dt4)) f32)) (fun (pairT f32 ?dt3) f32))) (fun (arrT ?n5 (pairT f32 ?dt3)) (arrT ?n5 f32))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n5 f32) (fun (arrT ?n5 ?dt3) (arrT ?n5 (pairT f32 ?dt3))))) (typeOf %e1 (arrT ?n5 f32))) (fun (arrT ?n5 ?dt3) (arrT ?n5 (pairT f32 ?dt3)))) (typeOf %e0 (arrT ?n5 ?dt3))) (arrT ?n5 (pairT f32 ?dt3)))) (arrT ?n5 f32))) (fun (arrT ?n6 ?dt5) (arrT ?n6 f32)))) (fun (arrT ?n3 f32) (fun (arrT ?n3 ?dt2) (arrT ?n3 f32))))) (fun (arrT ?n3 f32) (fun (arrT ?n4 (arrT ?n3 ?dt2)) (arrT ?n3 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT ?n3 f32) (arrT ?n3 (arrT ?n4 ?dt2))) (arrT ?n3 f32))) (typeOf %e0 (pairT (arrT ?n3 f32) (arrT ?n3 (arrT ?n4 ?dt2))))) (arrT ?n3 f32))) (fun (arrT ?n4 (arrT ?n3 ?dt2)) (arrT ?n3 f32))) (typeOf (app (typeOf transpose (fun (arrT ?n3 (arrT ?n4 ?dt2)) (arrT ?n4 (arrT ?n3 ?dt2)))) (typeOf (app (typeOf snd (fun (pairT (arrT ?n3 f32) (arrT ?n3 (arrT ?n4 ?dt2))) (arrT ?n3 (arrT ?n4 ?dt2)))) (typeOf %e0 (pairT (arrT ?n3 f32) (arrT ?n3 (arrT ?n4 ?dt2))))) (arrT ?n3 (arrT ?n4 ?dt2)))) (arrT ?n4 (arrT ?n3 ?dt2)))) (arrT ?n3 f32))) (fun (pairT (arrT ?n7 f32) (arrT ?n7 (arrT ?n0 ?dt0))) (arrT ?n7 f32))) (typeOf (app (typeOf unzip (fun (arrT ?n7 (pairT f32 (arrT ?n0 ?dt0))) (pairT (arrT ?n7 f32) (arrT ?n7 (arrT ?n0 ?dt0))))) (typeOf %e0 (arrT ?n7 (pairT f32 (arrT ?n0 ?dt0))))) (pairT (arrT ?n7 f32) (arrT ?n7 (arrT ?n0 ?dt0))))) (arrT ?n7 f32))) (fun (arrT ?n2 (pairT f32 (arrT ?n1 ?dt1))) (arrT ?n2 f32)))"))))))))))))) }),
        rewrite!("lift-reduce-seq-3"; "(typeOf (app (typeOf map ?tAny43) (typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?tAny44) (typeOf ?0 (fun (arrT ?n0 ?dt0) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt0))))) ?tAny45) (typeOf (app (typeOf fst ?tAny46) (typeOf (app (typeOf unzip ?tAny47) (typeOf %e0 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n0 ?dt0))) ?tAny48) (typeOf (app (typeOf transpose ?tAny49) (typeOf (app (typeOf snd ?tAny50) (typeOf (app (typeOf unzip ?tAny51) (typeOf %e0 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n1 (arrT ?n0 ?dt1)))) ?tAny52)) (fun (arrT ?n2 (pairT ?dt2 (arrT ?n3 ?dt3))) (arrT ?n2 ?dt2)))) (fun (arrT ?n4 (arrT ?n2 (pairT ?dt2 (arrT ?n3 ?dt3)))) (arrT ?n4 (arrT ?n2 ?dt2))))" => { NotFreeIn::new("?0", 0, Shifted::new("?0", "?1", 3, 1, ShiftedCheck::new("?n3", "?n1", 1, 0, Shifted::new("?n4", "?n7", 3, 0, Shifted::new("?n4", "?n9", 2, 0, Shifted::new("?n4", "?n5", 1, 0, Shifted::new("?n2", "?n8", 4, 0, Shifted::new("?n2", "?n6", 3, 0, Shifted::new("?n2", "?n10", 2, 0, ShiftedCheck::new("?n2", "?n0", 1, 0, Shifted::new("?dt3", "?dt7", 4, 0, Shifted::new("?dt3", "?dt5", 3, 0, Shifted::new("?dt3", "?dt8", 2, 0, ShiftedCheck::new("?dt3", "?dt1", 1, 0, Shifted::new("?dt2", "?dt6", 4, 0, Shifted::new("?dt2", "?dt4", 3, 0, Shifted::new("?dt2", "?dt9", 2, 0, ShiftedCheck::new("?dt2", "?dt0", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun (arrT ?n5 (arrT ?n0 ?dt0)) (fun (arrT ?n5 (arrT ?n0 ?dt1)) (arrT ?n5 (arrT ?n0 ?dt0)))) (fun (arrT ?n5 (arrT ?n0 ?dt0)) (fun (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))) (arrT ?n5 (arrT ?n0 ?dt0)))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5)) (arrT ?n6 ?dt4)) (fun (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5))) (arrT ?n7 (arrT ?n6 ?dt4))))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?1 (fun (arrT ?n8 ?dt6) (fun (arrT ?n8 ?dt7) (arrT ?n8 ?dt6)))) (typeOf (app (typeOf fst (fun (pairT (arrT ?n8 ?dt6) (arrT ?n8 ?dt7)) (arrT ?n8 ?dt6))) (typeOf %e0 (pairT (arrT ?n8 ?dt6) (arrT ?n8 ?dt7)))) (arrT ?n8 ?dt6))) (fun (arrT ?n8 ?dt7) (arrT ?n8 ?dt6))) (typeOf (app (typeOf snd (fun (pairT (arrT ?n8 ?dt6) (arrT ?n8 ?dt7)) (arrT ?n8 ?dt7))) (typeOf %e0 (pairT (arrT ?n8 ?dt6) (arrT ?n8 ?dt7)))) (arrT ?n8 ?dt7))) (arrT ?n8 ?dt6))) (fun (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5)) (arrT ?n6 ?dt4)))) (fun (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5))) (arrT ?n7 (arrT ?n6 ?dt4)))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n7 (arrT ?n6 ?dt4)) (fun (arrT ?n7 (arrT ?n6 ?dt5)) (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5)))))) (typeOf %e1 (arrT ?n7 (arrT ?n6 ?dt4)))) (fun (arrT ?n7 (arrT ?n6 ?dt5)) (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5))))) (typeOf %e0 (arrT ?n7 (arrT ?n6 ?dt5)))) (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5))))) (arrT ?n7 (arrT ?n6 ?dt4)))) (fun (arrT ?n9 (arrT ?n10 ?dt8)) (arrT ?n9 (arrT ?n10 ?dt9))))) (fun (arrT ?n5 (arrT ?n0 ?dt0)) (fun (arrT ?n5 (arrT ?n0 ?dt1)) (arrT ?n5 (arrT ?n0 ?dt0)))))) (fun (arrT ?n5 (arrT ?n0 ?dt0)) (fun (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))) (arrT ?n5 (arrT ?n0 ?dt0))))) (typeOf (app (typeOf fst (fun (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n5 (arrT ?n0 ?dt0)))) (typeOf (app (typeOf unzip (fun (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (fun (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))))) (typeOf unzip (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (fun (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf %e0 (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))))) (arrT ?n5 (arrT ?n0 ?dt0)))) (fun (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))) (arrT ?n5 (arrT ?n0 ?dt0)))) (typeOf (app (typeOf transpose (fun (arrT ?n5 (arrT ?n1 (arrT ?n0 ?dt1))) (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n5 (arrT ?n1 (arrT ?n0 ?dt1)))))) (typeOf transpose (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))))) (fun (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n5 (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf snd (fun (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1))))) (typeOf (app (typeOf unzip (fun (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (fun (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))))) (typeOf unzip (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (fun (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf %e0 (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))))) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n5 (arrT ?n1 (arrT ?n0 ?dt1))))) (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))))) (arrT ?n5 (arrT ?n0 ?dt0)))) (fun (arrT ?n4 (arrT ?n2 (pairT ?dt2 (arrT ?n3 ?dt3)))) (arrT ?n4 (arrT ?n2 ?dt2))))"))))))))))))))))))) }),
        rewrite!("transpose-around-map-map-f-1m"; "(typeOf (app (typeOf (app (typeOf map ?tAny53) (typeOf (app (typeOf map ?tAny54) (typeOf (app (typeOf map ?tAny55) (typeOf ?0 (fun ?dt0 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT ?n0 ?dt1))))) ?tAny56) (typeOf ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))" => { pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1)))))) (typeOf transpose (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf (app (typeOf map (fun (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt1)) (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt1)))) (typeOf ?0 (fun ?dt0 ?dt1))) (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt1)))) (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt1))))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt0))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0)))))) (typeOf transpose (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt0))))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))))) (typeOf ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))") }),
        // below not necessary for blocking
        // rewrite!("store-to-mem"; "(typeOf ?0 ?dt0)" => { Shifted::new("?dt0", "?dt1", 1, 0, pat("(typeOf (app (typeOf (app (typeOf let (fun ?dt0 (fun (fun ?dt0 ?dt0) ?dt0))) (typeOf (app (typeOf toMem (fun ?dt0 ?dt0)) (typeOf ?0 ?dt0)) ?dt0)) (fun (fun ?dt0 ?dt0) ?dt0)) (typeOf (lam (typeOf %e0 ?dt1)) (fun ?dt0 ?dt0))) ?dt0)")) }),
        // rewrite!("map-array"; "(typeOf ?0 (arrT ?n0 ?dt0))" => { Shifted::new("?dt0", "?dt1", 1, 0, pat("(typeOf (app (typeOf (app (typeOf map (fun (fun ?dt0 ?dt0) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0)))) (typeOf (lam (typeOf %e0 ?dt1)) (fun ?dt0 ?dt0))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0))) (typeOf ?0 (arrT ?n0 ?dt0))) (arrT ?n0 ?dt0))")) }),
        // rewrite!("map-fusion"; "(typeOf (app (typeOf (app (typeOf map ?tAny57) (typeOf ?0 (fun ?dt0 ?dt1))) ?tAny58) (typeOf (app (typeOf (app (typeOf map ?tAny59) (typeOf ?1 (fun ?dt2 ?dt0))) ?tAny60) (typeOf ?2 (arrT ?n0 ?dt2))) (arrT ?n0 ?dt0))) (arrT ?n0 ?dt1))" => { Shifted::new("?1", "?4", 1, 0, Shifted::new("?0", "?3", 1, 0, Shifted::new("?dt2", "?dt5", 1, 0, Shifted::new("?dt0", "?dt3", 1, 0, Shifted::new("?dt1", "?dt4", 1, 0, pat("(typeOf (app (typeOf (app (typeOf map (fun (fun ?dt2 ?dt1) (fun (arrT ?n0 ?dt2) (arrT ?n0 ?dt1)))) (typeOf (lam (typeOf (app (typeOf ?3 (fun ?dt3 ?dt4)) (typeOf (app (typeOf ?4 (fun ?dt5 ?dt3)) (typeOf %e0 ?dt5)) ?dt3)) ?dt4)) (fun ?dt2 ?dt1))) (fun (arrT ?n0 ?dt2) (arrT ?n0 ?dt1))) (typeOf ?2 (arrT ?n0 ?dt2))) (arrT ?n0 ?dt1))")))))) }),
        // rewrite!("map-eta-abstraction"; "(typeOf (app (typeOf map ?tAny61) (typeOf ?0 (fun ?dt0 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))" => { Shifted::new("?0", "?1", 1, 0, Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt0", "?dt2", 1, 0, Shifted::new("?dt1", "?dt3", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun ?dt2 ?dt3) (fun (arrT ?n1 ?dt2) (arrT ?n1 ?dt3)))) (typeOf ?1 (fun ?dt2 ?dt3))) (fun (arrT ?n1 ?dt2) (arrT ?n1 ?dt3))) (typeOf %e0 (arrT ?n1 ?dt2))) (arrT ?n1 ?dt3))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))"))))) }),
        // rewrite!("vec-32-after-f32"; "(typeOf ?0 (arrT ?n0 f32))" => { Shifted::new("?n0", "?n1", 1, 0, pat("(typeOf (app (typeOf asScalar (fun (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 f32)) (arrT ?n0 f32))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 (natMul (natPow 32 -1) ?n1)) f32) (arrT (natMul (natPow 32 -1) ?n1) (vecT %n0 f32))))) 32) (fun (arrT ?n0 f32) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 f32)))) (typeOf ?0 (arrT ?n0 f32))) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 f32)))) (arrT ?n0 f32))")) }),
        // rewrite!("vec-32-after-(f32, f32)"; "(typeOf ?0 (arrT ?n0 (pairT f32 f32)))" => { Shifted::new("?n0", "?n1", 1, 0, pat("(typeOf (app (typeOf asScalar (fun (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 f32))) (arrT ?n0 (pairT f32 f32)))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 (natMul (natPow 32 -1) ?n1)) (pairT f32 f32)) (arrT (natMul (natPow 32 -1) ?n1) (vecT %n0 (pairT f32 f32)))))) 32) (fun (arrT ?n0 (pairT f32 f32)) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 f32))))) (typeOf ?0 (arrT ?n0 (pairT f32 f32)))) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 f32))))) (arrT ?n0 (pairT f32 f32)))")) }),
        // rewrite!("vec-32-after-(f32, (f32, f32))"; "(typeOf ?0 (arrT ?n0 (pairT f32 (pairT f32 f32))))" => { Shifted::new("?n0", "?n1", 1, 0, pat("(typeOf (app (typeOf asScalar (fun (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 (pairT f32 f32)))) (arrT ?n0 (pairT f32 (pairT f32 f32))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 (natMul (natPow 32 -1) ?n1)) (pairT f32 (pairT f32 f32))) (arrT (natMul (natPow 32 -1) ?n1) (vecT %n0 (pairT f32 (pairT f32 f32))))))) 32) (fun (arrT ?n0 (pairT f32 (pairT f32 f32))) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 (pairT f32 f32)))))) (typeOf ?0 (arrT ?n0 (pairT f32 (pairT f32 f32))))) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 (pairT f32 f32)))))) (arrT ?n0 (pairT f32 (pairT f32 f32))))")) }),
        // rewrite!("vec-before-map-f32"; "(typeOf (app (typeOf (natApp (typeOf asVector ?tAny62) ?n0) ?tAny63) (typeOf (app (typeOf (app (typeOf map ?tAny64) (typeOf ?0 (fun f32 f32))) ?tAny65) (typeOf ?1 (arrT ?n1 f32))) (arrT ?n2 f32))) (arrT ?n3 (vecT ?n0 f32)))" => { VectorizeScalarFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", 1, 0, ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (vecT ?n0 f32) (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (vecT ?n0 f32))))) (typeOf ?2 (fun (vecT ?n0 f32) (vecT ?n0 f32)))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf ?1 (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32)))"))))) }),
        // rewrite!("vec-before-map-f32xf32"; "(typeOf (app (typeOf (natApp (typeOf asVector ?tAny66) ?n0) ?tAny67) (typeOf (app (typeOf (app (typeOf map ?tAny68) (typeOf ?0 (fun (pairT f32 f32) f32))) ?tAny69) (typeOf ?1 (arrT ?n1 (pairT f32 f32)))) (arrT ?n2 f32))) (arrT ?n3 (vecT ?n0 f32)))" => { VectorizeScalarFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", 1, 0, ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (pairT (vecT ?n0 f32) (vecT ?n0 f32)) (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (vecT ?n0 f32))))) (typeOf ?2 (fun (pairT (vecT ?n0 f32) (vecT ?n0 f32)) (vecT ?n0 f32)))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (arrT ?n3 (vecT ?n0 f32)))"))))) }),
        // rewrite!("vec-before-map-f32x-f32xf32"; "(typeOf (app (typeOf (natApp (typeOf asVector ?tAny70) ?n0) ?tAny71) (typeOf (app (typeOf (app (typeOf map ?tAny72) (typeOf ?0 (fun (pairT f32 (pairT f32 f32)) f32))) ?tAny73) (typeOf ?1 (arrT ?n1 (pairT f32 (pairT f32 f32))))) (arrT ?n2 f32))) (arrT ?n3 (vecT ?n0 f32)))" => { VectorizeScalarFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", 1, 0, ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32))))) (typeOf ?2 (fun (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (vecT ?n0 f32)))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (arrT ?n3 (vecT ?n0 f32)))"))))) }),
        // rewrite!("reduce-seq-unroll"; "(typeOf reduceSeq (fun (fun ?dt0 (fun ?dt1 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt1) ?dt0))))" => { pat("(typeOf reduceSeqUnroll (fun (fun ?dt0 (fun ?dt1 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt1) ?dt0))))") }),
        // rewrite!("map-par"; "(typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))))" => { pat("(typeOf mapPar (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))))") }),
    ];
    algorithmic.extend([
            // // OLD: rewrite!("beta"; "(app (lam ?body) ?e)" => { BetaExtractApplier::new("?body", "?e") }),
            rewrite!("beta"; "(app (typeOf (lam (typeOf ?body ?bodyTy)) ?lamTy) (typeOf ?subs ?subsTy))" => { BetaExtractApplier::new("?body", "?subs", Kind::Expr) }),
            rewrite!("beta-nat"; "(natApp (typeOf (natLam (typeOf ?body ?bodyTy)) ?lamTy) (typeOf ?subs ?subsTy))" => { BetaExtractApplier::new("?body", "?subs",Kind::Nat) }),
            rewrite!("beta-data"; "(dataApp (typeOf (dataLam (typeOf ?body ?bodyTy)) ?lamTy) (typeOf ?subs ?subsTy))" => { BetaExtractApplier::new("?body", "?subs",Kind::Data) }),
            rewrite!("beta-addr"; "(addrApp (typeOf (addrLam (typeOf ?body ?bodyTy)) ?lamTy) (typeOf ?subs ?subsTy))" => { BetaExtractApplier::new("?body", "?subs",Kind::Addr) }),
            // // rewrite!("beta-nat-nat"; "(natNatApp (typeOf (natNatLam (typeOf ?body ?bodyTy)) ?lamTy) (typeOf ?subs ?subsTy))" => { BetaExtractApplier::new("?body", "?subs") }),
     ]);
    algorithmic
}

struct BetaExtractApplier {
    body: Var,
    subs: Var,
    kind: Kind,
}

impl BetaExtractApplier {
    fn new(body: &str, subs: &str, kind: Kind) -> Self {
        Self {
            body: body.parse().unwrap(),
            subs: subs.parse().unwrap(),
            kind,
        }
    }
}

impl Applier<Rise, RiseAnalysis> for BetaExtractApplier {
    fn apply_one(
        &self,
        egraph: &mut EGraph<Rise, RiseAnalysis>,
        eclass: Id,
        subst: &Subst,
        _searcher_ast: Option<&PatternAst<Rise>>,
        _rule_name: Symbol,
    ) -> Vec<Id> {
        let ex_body = &egraph[subst[self.body]].data.beta_extract;
        let ex_subs = &egraph[subst[self.subs]].data.beta_extract;

        // println!("Attempting beta reduction on:");
        // egraph[eclass].data.beta_extract.pp(false);
        // println!("\nBody:");
        // ex_body.pp(false);
        // println!("Subs:");
        // ex_subs.pp(false);
        // println!("Kind is {:?}", self.kind);
        let result = beta_reduce(ex_body, ex_subs, self.kind);

        // println!("Result:");
        // result.pp(false);

        // // no use reducing smth that is already reduced
        // if result == egraph[eclass].data.beta_extract {
        //     println!("Already beta reduced, nothing to do");
        //     return vec![];
        // }

        let id = egraph.add_expr(&result);
        egraph.union(eclass, id);

        vec![id]
    }
}

pub fn beta_reduce(body: &RecExpr<Rise>, arg: &RecExpr<Rise>, kind: Kind) -> RecExpr<Rise> {
    let arg2 = &mut arg.to_owned();
    shift_mut(arg2, DBShift::up(), DBIndex::zero(kind)); // shift up
    let mut body2 = replace(body, DBIndex::zero(kind), arg2);
    shift_mut(&mut body2, DBShift::down(), DBIndex::zero(kind)); // shift down
    body2
}

fn replace(expr: &RecExpr<Rise>, to_replace: DBIndex, subs: &mut RecExpr<Rise>) -> RecExpr<Rise> {
    let mut result = RecExpr::default();
    replace_rec(&mut result, expr, expr.root(), to_replace, subs);
    result
}

fn replace_rec(
    result: &mut RecExpr<Rise>,
    expr: &RecExpr<Rise>,
    id: Id,
    to_replace: DBIndex,
    subs: &mut RecExpr<Rise>,
) -> Id {
    let node = &expr[id];
    // println!("Node: {node}, Index: {to_replace}");
    match node {
        Rise::Var(found) if to_replace == *found => super::add_expr(result, subs.clone()),
        Rise::Lambda(e) if node.kind() == to_replace.kind() => {
            shift_replace(result, expr, to_replace, subs, *e, Rise::Lambda)
        }
        Rise::NatLambda(e) if node.kind() == to_replace.kind() => {
            shift_replace(result, expr, to_replace, subs, *e, Rise::NatLambda)
        }
        Rise::DataLambda(e) if node.kind() == to_replace.kind() => {
            shift_replace(result, expr, to_replace, subs, *e, Rise::DataLambda)
        }
        Rise::AddrLambda(e) if node.kind() == to_replace.kind() => {
            shift_replace(result, expr, to_replace, subs, *e, Rise::AddrLambda)
        }
        Rise::NatFun(e) if node.kind() == to_replace.kind() => {
            shift_replace(result, expr, to_replace, subs, *e, Rise::NatFun)
        }
        Rise::DataFun(e) if node.kind() == to_replace.kind() => {
            shift_replace(result, expr, to_replace, subs, *e, Rise::DataFun)
        }
        Rise::AddrFun(e) if node.kind() == to_replace.kind() => {
            shift_replace(result, expr, to_replace, subs, *e, Rise::AddrFun)
        }
        // NatNatLam and NatNatFun are not covered
        // Non-matching vars and lambdas are handled by the default case
        other => {
            let new_other = other
                .clone()
                .map_children(|i| replace_rec(result, expr, i, to_replace, subs));
            result.add(new_other)
        }
    }
}

fn shift_replace<F: FnOnce(Id) -> Rise>(
    result: &mut RecExpr<Rise>,
    expr: &RecExpr<Rise>,
    index: DBIndex,
    subs: &mut RecExpr<Rise>,
    e: Id,
    constructor: F,
) -> Id {
    let zero = DBIndex::zero(index.kind());
    shift_mut(subs, DBShift::up(), zero);
    let e2 = replace_rec(result, expr, e, index.inc(), subs);
    shift_mut(subs, DBShift::down(), zero);
    result.add(constructor(e2))
}

#[cfg(test)]
mod tests {
    use egg::Pattern;

    use super::*;
    use crate::rewrite_system::rise::PrettyPrint;

    #[test]
    fn print_rule() {
        let split_join_32: Pattern<Rise> = "(typeOf (app (typeOf join (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)) (arrT ?n0 ?dt1))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT 32 ?dt0) (arrT 32 ?dt1)) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (typeOf ?0 (fun ?dt0 ?dt1))) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (typeOf (app (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 (natMul (natPow 32 -1) ?n1)) ?dt2) (arrT (natMul (natPow 32 -1) ?n1) (arrT %n0 ?dt2))))) 32) (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (typeOf ?1 (arrT ?n0 ?dt0))) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (arrT ?n0 ?dt1))".parse().unwrap();
        println!("split-join-32");
        split_join_32.ast.pp(false);
        let split_join_2m_32: Pattern<Rise> ="(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1)))))) (typeOf (app (typeOf map (fun (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)) (arrT ?n0 ?dt1)) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf join (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)) (arrT ?n0 ?dt1)))) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))))) (typeOf (app (typeOf map (fun (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (typeOf (app (typeOf map (fun (fun (arrT 32 ?dt0) (arrT 32 ?dt1)) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (typeOf ?0 (fun ?dt0 ?dt1))) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))))))) (typeOf (app (typeOf map (fun (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 (natMul (natPow 32 -1) ?n3)) ?dt2) (arrT (natMul (natPow 32 -1) ?n3) (arrT %n0 ?dt2))))) 32) (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (typeOf ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))".parse().unwrap();
        println!("split-join-2m-32");
        split_join_2m_32.ast.pp(false);
    }

    #[test]
    fn beta_reduce_applier() {
        fn check(body: &str, arg: &str, res: &str) {
            let b = &body.parse().unwrap();
            let a = &arg.parse().unwrap();
            let r = res.parse().unwrap();
            assert_eq!(beta_reduce(b, a, Kind::Expr), r);
        }
        // (λ. (λ. ((λ. (0 1)) (0 1)))) --> (λ. (λ. ((0 1) 0)))
        // (λ. (0 1)) (0 1) --> (0 1) 0
        check("(app %e0 %e1)", "(app %e0 %e1)", "(app (app %e0 %e1) %e0)");
        // r1 = (app (lam (app "%e6" (app "%e5" "%e0"))) "%e0")
        // r2 = (app (lam (app "%e6" r1)) "%e0")
        // r3 = (app (lam (app "%e6" r2)) %e0)
        // (app map (lam (app "%e6" r3)))
        // --> (app map (lam (app "%e6" (app "%e5" (app "%e4" (app "%e3" (app "%e2" "%e0")))))))
        check("(app %e6 (app %e5 %e0))", "%e0", "(app %e5 (app %e4 %e0))");
        check(
            "(app %e6 (app %e5 (app %e4 %e0)))",
            "%e0",
            "(app %e5 (app %e4 (app %e3 %e0)))",
        );
        check(
            "(app %e6 (app %e5 (app %e4 (app %e3 %e0))))",
            "%e0",
            "(app %e5 (app %e4 (app %e3 (app %e2 %e0))))",
        );
    }

    #[test]
    fn parse_rules() {
        let _ = mm_rules();
        // assert_eq!(31, rules.len());
    }
}
