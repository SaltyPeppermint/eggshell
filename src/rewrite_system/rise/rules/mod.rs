mod func;
mod nat;
mod shifted;

use std::iter;

use egg::{
    Applier, AstSize, EGraph, ENodeOrVar, Extractor, Id, Language, Pattern, PatternAst, RecExpr,
    Rewrite, Searcher, Subst, Symbol, Var, rewrite,
};

use super::{Index, Rise, RiseAnalysis};

use func::{NotFreeIn, VectorizeScalaFun, pat};
use nat::ComputeNatCheck;
use shifted::{Shifted, ShiftedCheck, shift_mut};

pub fn mm_rules() -> Vec<Rewrite<Rise, RiseAnalysis>> {
    // let mut algorithmic = vec![
    //     rw!("map-fission"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf (app (typeOf ?e0 ?) (typeOf ?e1 ?dt0)) ?)) (app (app fun ?dt1) ?dt2))) (app (app fun (app (app arrT ?n0) ?dt1)) (app (app arrT ?n0) ?dt2)))" => { not_free_in("?0", 0, shifted("?1", "?2", 1, 1, shifted("?n0", "?n1", 1, 0, shifted("?dt1", "?dt4", 1, 0, shifted("?dt2", "?dt3", 1, 0, shifted("?dt0", "?dt5", 1, 1, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun ?dt0) ?dt3)) (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt3)))) (typeOf ?e0 (app (app fun ?dt0) ?dt3))) (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt3))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun ?dt4) ?dt0)) (app (app fun (app (app arrT ?n1) ?dt4)) (app (app arrT ?n1) ?dt0)))) (typeOf (lam (typeOf ?e2 ?dt5)) (app (app fun ?dt4) ?dt0))) (app (app fun (app (app arrT ?n1) ?dt4)) (app (app arrT ?n1) ?dt0))) (typeOf %0 (app (app arrT ?n1) ?dt4))) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n1) ?dt3))) (app (app fun (app (app arrT ?n0) ?dt1)) (app (app arrT ?n0) ?dt2)))"))))))) }),
    //     rw!("reduce-seq"; "(typeOf reduce (app (app fun (app (app fun ?dt0) (app (app fun ?dt0) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt0)) ?dt0))))" => "(typeOf reduceSeq (app (app fun (app (app fun ?dt0) (app (app fun ?dt0) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt0)) ?dt0))))"),
    //     rw!("eliminate-map-identity"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf %0 ?)) (app (app fun ?dt0) ?dt0))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0)))" => { shifted("?n0", "?n1", 1, 0, shifted("?dt0", "?dt1", 1, 0, pat("(typeOf (lam (typeOf %0 (app (app arrT ?n1) ?dt1))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0)))"))) }),
    //     rw!("reduce-seq-map-fusion"; "(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf ?e0 (app (app fun ?dt0) (app (app fun ?dt1) ?dt0)))) ?) (typeOf ?e1 ?dt0)) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e2 (app (app fun ?dt2) ?dt1))) ?) (typeOf ?e3 (app (app arrT ?n0) ?dt2))) (app (app arrT ?n0) ?dt1))) ?dt0)" => { shifted("?2", "?5", 2, 0, shifted("?0", "?4", 2, 0, shifted("?dt2", "?dt5", 2, 0, shifted("?dt2", "?dt6", 1, 0, shifted("?dt1", "?dt4", 2, 0, shifted("?dt0", "?dt3", 2, 0, shifted("?dt0", "?dt7", 1, 0, pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (app (app fun (app (app fun ?dt0) (app (app fun ?dt2) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt2)) ?dt0)))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e4 (app (app fun ?dt3) (app (app fun ?dt4) ?dt3))) (typeOf %1 ?dt3)) (app (app fun ?dt4) ?dt3)) (typeOf (app (typeOf ?e5 (app (app fun ?dt5) ?dt4)) (typeOf %0 ?dt5)) ?dt4)) ?dt3)) (app (app fun ?dt6) ?dt7))) (app (app fun ?dt0) (app (app fun ?dt2) ?dt0)))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt2)) ?dt0))) (typeOf ?e1 ?dt0)) (app (app fun (app (app arrT ?n0) ?dt2)) ?dt0)) (typeOf ?e3 (app (app arrT ?n0) ?dt2))) ?dt0)")))))))) }),
    //     rw!("split-join-32"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) ?) (typeOf ?e1 (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) ?dt1))" => { shifted("?n0", "?n1", 1, 0, shifted("?dt0", "?dt2", 1, 0, pat("(typeOf (app (typeOf join (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))) (app (app arrT ?n0) ?dt1))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT 32) ?dt0)) (app (app arrT 32) ?dt1))) (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))))) (typeOf (app (typeOf map (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT 32) ?dt0)) (app (app arrT 32) ?dt1)))) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT 32) ?dt0)) (app (app arrT 32) ?dt1)))) (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))) (typeOf (app (typeOf (app (typeOf split (lam (app (app fun (app (app arrT (app (app mul %0) (app (app mul (app (app pow 32) -1)) ?n1))) ?dt2)) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n1)) (app (app arrT %0) ?dt2))))) 32) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))) (typeOf ?e1 (app (app arrT ?n0) ?dt0))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))) (app (app arrT ?n0) ?dt1))"))) }),
    //     rw!("split-join-2m-32"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) ?) (typeOf ?e1 (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))" => { shifted("?n0", "?n3", 1, 0, shifted("?dt0", "?dt2", 1, 0, pat("(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))))) (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))) (app (app arrT ?n0) ?dt1))) (app (app fun (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (typeOf join (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))))))) (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))) (app (app fun (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))))) (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT 32) ?dt0)) (app (app arrT 32) ?dt1))) (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))))) (typeOf (app (typeOf map (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT 32) ?dt0)) (app (app arrT 32) ?dt1)))) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT 32) ?dt0)) (app (app arrT 32) ?dt1)))) (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1))))) (app (app fun (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))))))) (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))))) (typeOf (app (typeOf split (lam (app (app fun (app (app arrT (app (app mul %0) (app (app mul (app (app pow 32) -1)) ?n3))) ?dt2)) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n3)) (app (app arrT %0) ?dt2))))) 32) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0))))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))))) (typeOf ?e1 (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt0)))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app arrT 32) ?dt1)))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))"))) }),
    //     rw!("blocked-reduce-4"; "(typeOf (app (typeOf (app (typeOf (app (typeOf reduce ?) (typeOf ?e0 (app (app fun ?dt0) (app (app fun ?dt0) ?dt0)))) ?) (typeOf ?e1 ?dt0)) ?) (typeOf ?e2 (app (app arrT ?n0) ?dt0))) ?dt0)" => { shifted("?1", "?4", 2, 0, shifted("?0", "?3", 2, 0, shifted("?n0", "?n1", 1, 0, shifted("?dt0", "?dt1", 2, 0, shifted("?dt0", "?dt2", 1, 0, pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (app (app fun (app (app fun ?dt0) (app (app fun (app (app arrT 4) ?dt0)) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT (app (app mul (app (app pow 4) -1)) ?n0)) (app (app arrT 4) ?dt0))) ?dt0)))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e3 (app (app fun ?dt1) (app (app fun ?dt1) ?dt1))) (typeOf %1 ?dt1)) (app (app fun ?dt1) ?dt1)) (typeOf (app (typeOf (app (typeOf (app (typeOf reduce (app (app fun (app (app fun ?dt1) (app (app fun ?dt1) ?dt1))) (app (app fun ?dt1) (app (app fun (app (app arrT 4) ?dt1)) ?dt1)))) (typeOf ?e3 (app (app fun ?dt1) (app (app fun ?dt1) ?dt1)))) (app (app fun ?dt1) (app (app fun (app (app arrT 4) ?dt1)) ?dt1))) (typeOf ?e4 ?dt1)) (app (app fun (app (app arrT 4) ?dt1)) ?dt1)) (typeOf %0 (app (app arrT 4) ?dt1))) ?dt1)) ?dt1)) (app (app fun (app (app arrT 4) ?dt2)) ?dt2))) (app (app fun ?dt0) (app (app fun (app (app arrT 4) ?dt0)) ?dt0)))) (app (app fun ?dt0) (app (app fun (app (app arrT (app (app mul (app (app pow 4) -1)) ?n0)) (app (app arrT 4) ?dt0))) ?dt0))) (typeOf ?e1 ?dt0)) (app (app fun (app (app arrT (app (app mul (app (app pow 4) -1)) ?n0)) (app (app arrT 4) ?dt0))) ?dt0)) (typeOf (app (typeOf (app (typeOf split (lam (app (app fun (app (app arrT (app (app mul %0) (app (app mul (app (app pow 4) -1)) ?n1))) ?dt2)) (app (app arrT (app (app mul (app (app pow 4) -1)) ?n1)) (app (app arrT %0) ?dt2))))) 4) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT (app (app mul (app (app pow 4) -1)) ?n0)) (app (app arrT 4) ?dt0)))) (typeOf ?e2 (app (app arrT ?n0) ?dt0))) (app (app arrT (app (app mul (app (app pow 4) -1)) ?n0)) (app (app arrT 4) ?dt0)))) ?dt0)")))))) }),
    //     rw!("split-before-map"; "(typeOf (app (typeOf (app (typeOf split ?) ?n0) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) ?) (typeOf ?e1 (app (app arrT ?n1) ?dt0))) (app (app arrT ?n2) ?dt1))) (app (app arrT ?n3) (app (app arrT ?n0) ?dt1)))" => { shifted("?n3", "?n4", 1, 0, shifted("?dt0", "?dt2", 1, 0, compute_nat_check("?n1", "(app (app mul ?n3) ?n0)", compute_nat_check("?n2", "(app (app mul ?n3) ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1))) (app (app fun (app (app arrT ?n3) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n3) (app (app arrT ?n0) ?dt1))))) (typeOf (app (typeOf map (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1)))) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n3) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n3) (app (app arrT ?n0) ?dt1)))) (typeOf (app (typeOf (app (typeOf split (lam (app (app fun (app (app arrT (app (app mul %0) ?n4)) ?dt2)) (app (app arrT ?n4) (app (app arrT %0) ?dt2))))) ?n0) (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) ?dt0)) (app (app arrT ?n3) (app (app arrT ?n0) ?dt0)))) (typeOf ?e1 (app (app arrT (app (app mul ?n3) ?n0)) ?dt0))) (app (app arrT ?n3) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n3) (app (app arrT ?n0) ?dt1)))"))))) }),
    //     rw!("reduce-seq-map-fission"; "(typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e0 ?) (typeOf %1 ?dt0)) ?) (typeOf ?e1 ?dt1)) ?)) ?)) (app (app fun ?dt2) (app (app fun ?dt3) ?dt2)))) ?) (typeOf ?e2 ?dt2)) (app (app fun (app (app arrT ?n0) ?dt3)) ?dt2))" => { not_free_in("?0", 0, shifted("?2", "?4", 1, 0, shifted("?0", "?3", -1, 2, shifted("?n0", "?n1", 1, 0, shifted("?dt3", "?dt6", 1, 0, shifted_check("?dt2", "?dt0", 2, 0, shifted("?dt2", "?dt4", 1, 0, shifted("?dt1", "?dt5", -1, 2, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (app (app fun (app (app fun ?dt4) (app (app fun ?dt5) ?dt4))) (app (app fun ?dt4) (app (app fun (app (app arrT ?n1) ?dt5)) ?dt4)))) (typeOf ?e3 (app (app fun ?dt4) (app (app fun ?dt5) ?dt4)))) (app (app fun ?dt4) (app (app fun (app (app arrT ?n1) ?dt5)) ?dt4))) (typeOf ?e4 ?dt4)) (app (app fun (app (app arrT ?n1) ?dt5)) ?dt4)) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun ?dt6) ?dt5)) (app (app fun (app (app arrT ?n1) ?dt6)) (app (app arrT ?n1) ?dt5)))) (typeOf (lam (typeOf ?e1 ?dt1)) (app (app fun ?dt6) ?dt5))) (app (app fun (app (app arrT ?n1) ?dt6)) (app (app arrT ?n1) ?dt5))) (typeOf %0 (app (app arrT ?n1) ?dt6))) (app (app arrT ?n1) ?dt5))) ?dt4)) (app (app fun (app (app arrT ?n0) ?dt3)) ?dt2))"))))))))) }),
    //     rw!("lift-reduce-seq"; "(typeOf (app (typeOf map ?) (typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf ?e0 (app (app fun ?dt0) (app (app fun ?dt1) ?dt0)))) ?) (typeOf ?e1 ?dt0)) (app (app fun (app (app arrT ?n0) ?dt1)) ?dt0))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))) (app (app arrT ?n1) ?dt0)))" => { shifted("?1", "?3", 2, 0, shifted("?0", "?2", 4, 0, shifted("?n0", "?n3", 1, 0, shifted("?n1", "?n4", 3, 0, shifted("?n1", "?n5", 2, 0, shifted("?n1", "?n2", 1, 0, shifted("?dt1", "?dt7", 4, 0, shifted("?dt1", "?dt5", 3, 0, shifted("?dt1", "?dt8", 2, 0, shifted("?dt1", "?dt3", 1, 0, shifted("?dt0", "?dt6", 4, 0, shifted("?dt0", "?dt4", 3, 0, shifted("?dt0", "?dt9", 2, 0, shifted("?dt0", "?dt2", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (app (app fun (app (app fun (app (app arrT ?n2) ?dt2)) (app (app fun (app (app arrT ?n2) ?dt3)) (app (app arrT ?n2) ?dt2)))) (app (app fun (app (app arrT ?n2) ?dt2)) (app (app fun (app (app arrT ?n3) (app (app arrT ?n2) ?dt3))) (app (app arrT ?n2) ?dt2))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app pairT ?dt4) ?dt5)) ?dt4)) (app (app fun (app (app arrT ?n4) (app (app pairT ?dt4) ?dt5))) (app (app arrT ?n4) ?dt4)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e2 (app (app fun ?dt6) (app (app fun ?dt7) ?dt6))) (typeOf (app (typeOf fst (app (app fun (app (app pairT ?dt6) ?dt7)) ?dt6)) (typeOf %0 (app (app pairT ?dt6) ?dt7))) ?dt6)) (app (app fun ?dt7) ?dt6)) (typeOf (app (typeOf snd (app (app fun (app (app pairT ?dt6) ?dt7)) ?dt7)) (typeOf %0 (app (app pairT ?dt6) ?dt7))) ?dt7)) ?dt6)) (app (app fun (app (app pairT ?dt4) ?dt5)) ?dt4))) (app (app fun (app (app arrT ?n4) (app (app pairT ?dt4) ?dt5))) (app (app arrT ?n4) ?dt4))) (typeOf (app (typeOf (app (typeOf zip (app (app fun (app (app arrT ?n4) ?dt4)) (app (app fun (app (app arrT ?n4) ?dt5)) (app (app arrT ?n4) (app (app pairT ?dt4) ?dt5))))) (typeOf %1 (app (app arrT ?n4) ?dt4))) (app (app fun (app (app arrT ?n4) ?dt5)) (app (app arrT ?n4) (app (app pairT ?dt4) ?dt5)))) (typeOf %0 (app (app arrT ?n4) ?dt5))) (app (app arrT ?n4) (app (app pairT ?dt4) ?dt5)))) (app (app arrT ?n4) ?dt4))) (app (app fun (app (app arrT ?n5) ?dt8)) (app (app arrT ?n5) ?dt9)))) (app (app fun (app (app arrT ?n2) ?dt2)) (app (app fun (app (app arrT ?n2) ?dt3)) (app (app arrT ?n2) ?dt2))))) (app (app fun (app (app arrT ?n2) ?dt2)) (app (app fun (app (app arrT ?n3) (app (app arrT ?n2) ?dt3))) (app (app arrT ?n2) ?dt2)))) (typeOf (app (typeOf generate (app (app fun (app (app fun (app idxT ?n2)) ?dt2)) (app (app arrT ?n2) ?dt2))) (typeOf (lam (typeOf ?e3 ?dt9)) (app (app fun (app idxT ?n2)) ?dt2))) (app (app arrT ?n2) ?dt2))) (app (app fun (app (app arrT ?n3) (app (app arrT ?n2) ?dt3))) (app (app arrT ?n2) ?dt2))) (typeOf (app (typeOf transpose (app (app fun (app (app arrT ?n2) (app (app arrT ?n3) ?dt3))) (app (app arrT ?n3) (app (app arrT ?n2) ?dt3)))) (typeOf %0 (app (app arrT ?n2) (app (app arrT ?n3) ?dt3)))) (app (app arrT ?n3) (app (app arrT ?n2) ?dt3)))) (app (app arrT ?n2) ?dt2))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))) (app (app arrT ?n1) ?dt0)))"))))))))))))))) }),
    //     rw!("lift-reduce-seq-2"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf (app (typeOf (app (typeOf add ?) (typeOf (app (typeOf fst ?) (typeOf %0 (app (app pairT f32) (app (app arrT ?n0) ?dt0)))) f32)) ?) (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf ?e0 (app (app fun f32) (app (app fun ?dt0) f32)))) ?) (typeOf 0.0 f32)) ?) (typeOf (app (typeOf snd ?) (typeOf %0 (app (app pairT f32) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n0) ?dt0))) f32)) ?)) (app (app fun (app (app pairT f32) (app (app arrT ?n1) ?dt1))) f32))) (app (app fun (app (app arrT ?n2) (app (app pairT f32) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n2) f32)))" => { shifted("?0", "?1", 4, 1, shifted("?n1", "?n4", 2, 0, shifted_check("?n1", "?n0", 1, 0, shifted("?n2", "?n5", 4, 0, shifted("?n2", "?n6", 3, 0, shifted("?n2", "?n3", 2, 0, shifted("?n2", "?n7", 1, 0, shifted("?dt1", "?dt4", 5, 0, shifted("?dt1", "?dt3", 4, 0, shifted("?dt1", "?dt5", 3, 0, shifted("?dt1", "?dt2", 2, 0, shifted_check("?dt1", "?dt0", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (app (app fun (app (app fun (app (app arrT ?n3) f32)) (app (app fun (app (app arrT ?n3) ?dt2)) (app (app arrT ?n3) f32)))) (app (app fun (app (app arrT ?n3) f32)) (app (app fun (app (app arrT ?n4) (app (app arrT ?n3) ?dt2))) (app (app arrT ?n3) f32))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app pairT f32) ?dt3)) f32)) (app (app fun (app (app arrT ?n5) (app (app pairT f32) ?dt3))) (app (app arrT ?n5) f32)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e1 (app (app fun f32) (app (app fun ?dt4) f32))) (typeOf (app (typeOf fst (app (app fun (app (app pairT f32) ?dt4)) f32)) (typeOf %0 (app (app pairT f32) ?dt4))) f32)) (app (app fun ?dt4) f32)) (typeOf (app (typeOf snd (app (app fun (app (app pairT f32) ?dt4)) ?dt4)) (typeOf %0 (app (app pairT f32) ?dt4))) ?dt4)) f32)) (app (app fun (app (app pairT f32) ?dt3)) f32))) (app (app fun (app (app arrT ?n5) (app (app pairT f32) ?dt3))) (app (app arrT ?n5) f32))) (typeOf (app (typeOf (app (typeOf zip (app (app fun (app (app arrT ?n5) f32)) (app (app fun (app (app arrT ?n5) ?dt3)) (app (app arrT ?n5) (app (app pairT f32) ?dt3))))) (typeOf %1 (app (app arrT ?n5) f32))) (app (app fun (app (app arrT ?n5) ?dt3)) (app (app arrT ?n5) (app (app pairT f32) ?dt3)))) (typeOf %0 (app (app arrT ?n5) ?dt3))) (app (app arrT ?n5) (app (app pairT f32) ?dt3)))) (app (app arrT ?n5) f32))) (app (app fun (app (app arrT ?n6) ?dt5)) (app (app arrT ?n6) f32)))) (app (app fun (app (app arrT ?n3) f32)) (app (app fun (app (app arrT ?n3) ?dt2)) (app (app arrT ?n3) f32))))) (app (app fun (app (app arrT ?n3) f32)) (app (app fun (app (app arrT ?n4) (app (app arrT ?n3) ?dt2))) (app (app arrT ?n3) f32)))) (typeOf (app (typeOf fst (app (app fun (app (app pairT (app (app arrT ?n3) f32)) (app (app arrT ?n3) (app (app arrT ?n4) ?dt2)))) (app (app arrT ?n3) f32))) (typeOf %0 (app (app pairT (app (app arrT ?n3) f32)) (app (app arrT ?n3) (app (app arrT ?n4) ?dt2))))) (app (app arrT ?n3) f32))) (app (app fun (app (app arrT ?n4) (app (app arrT ?n3) ?dt2))) (app (app arrT ?n3) f32))) (typeOf (app (typeOf transpose (app (app fun (app (app arrT ?n3) (app (app arrT ?n4) ?dt2))) (app (app arrT ?n4) (app (app arrT ?n3) ?dt2)))) (typeOf (app (typeOf snd (app (app fun (app (app pairT (app (app arrT ?n3) f32)) (app (app arrT ?n3) (app (app arrT ?n4) ?dt2)))) (app (app arrT ?n3) (app (app arrT ?n4) ?dt2)))) (typeOf %0 (app (app pairT (app (app arrT ?n3) f32)) (app (app arrT ?n3) (app (app arrT ?n4) ?dt2))))) (app (app arrT ?n3) (app (app arrT ?n4) ?dt2)))) (app (app arrT ?n4) (app (app arrT ?n3) ?dt2)))) (app (app arrT ?n3) f32))) (app (app fun (app (app pairT (app (app arrT ?n7) f32)) (app (app arrT ?n7) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n7) f32))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT ?n7) (app (app pairT f32) (app (app arrT ?n0) ?dt0)))) (app (app pairT (app (app arrT ?n7) f32)) (app (app arrT ?n7) (app (app arrT ?n0) ?dt0))))) (typeOf %0 (app (app arrT ?n7) (app (app pairT f32) (app (app arrT ?n0) ?dt0))))) (app (app pairT (app (app arrT ?n7) f32)) (app (app arrT ?n7) (app (app arrT ?n0) ?dt0))))) (app (app arrT ?n7) f32))) (app (app fun (app (app arrT ?n2) (app (app pairT f32) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n2) f32)))"))))))))))))) }),
    //     rw!("lift-reduce-seq-3"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf ?e0 (app (app fun (app (app arrT ?n0) ?dt0)) (app (app fun (app (app arrT ?n0) ?dt1)) (app (app arrT ?n0) ?dt0))))) ?) (typeOf (app (typeOf fst ?) (typeOf (app (typeOf unzip ?) (typeOf %0 (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1))))) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n0) ?dt0))) ?) (typeOf (app (typeOf transpose ?) (typeOf (app (typeOf snd ?) (typeOf (app (typeOf unzip ?) (typeOf %0 (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1))))) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))) ?)) (app (app fun (app (app arrT ?n2) (app (app pairT ?dt2) (app (app arrT ?n3) ?dt3)))) (app (app arrT ?n2) ?dt2)))) (app (app fun (app (app arrT ?n4) (app (app arrT ?n2) (app (app pairT ?dt2) (app (app arrT ?n3) ?dt3))))) (app (app arrT ?n4) (app (app arrT ?n2) ?dt2))))" => { not_free_in("?0", 0, shifted("?0", "?1", 3, 1, shifted_check("?n3", "?n1", 1, 0, shifted("?n2", "?n8", 4, 0, shifted("?n2", "?n6", 3, 0, shifted("?n2", "?n10", 2, 0, shifted_check("?n2", "?n0", 1, 0, shifted("?n4", "?n7", 3, 0, shifted("?n4", "?n9", 2, 0, shifted("?n4", "?n5", 1, 0, shifted("?dt2", "?dt6", 4, 0, shifted("?dt2", "?dt4", 3, 0, shifted("?dt2", "?dt9", 2, 0, shifted_check("?dt2", "?dt0", 1, 0, shifted("?dt3", "?dt7", 4, 0, shifted("?dt3", "?dt5", 3, 0, shifted("?dt3", "?dt8", 2, 0, shifted_check("?dt3", "?dt1", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (app (app fun (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) ?dt1))) (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n5) (app (app arrT ?n0) ?dt1)))) (app (app arrT ?n5) (app (app arrT ?n0) ?dt0)))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app pairT (app (app arrT ?n6) ?dt4)) (app (app arrT ?n6) ?dt5))) (app (app arrT ?n6) ?dt4))) (app (app fun (app (app arrT ?n7) (app (app pairT (app (app arrT ?n6) ?dt4)) (app (app arrT ?n6) ?dt5)))) (app (app arrT ?n7) (app (app arrT ?n6) ?dt4))))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e1 (app (app fun (app (app arrT ?n8) ?dt6)) (app (app fun (app (app arrT ?n8) ?dt7)) (app (app arrT ?n8) ?dt6)))) (typeOf (app (typeOf fst (app (app fun (app (app pairT (app (app arrT ?n8) ?dt6)) (app (app arrT ?n8) ?dt7))) (app (app arrT ?n8) ?dt6))) (typeOf %0 (app (app pairT (app (app arrT ?n8) ?dt6)) (app (app arrT ?n8) ?dt7)))) (app (app arrT ?n8) ?dt6))) (app (app fun (app (app arrT ?n8) ?dt7)) (app (app arrT ?n8) ?dt6))) (typeOf (app (typeOf snd (app (app fun (app (app pairT (app (app arrT ?n8) ?dt6)) (app (app arrT ?n8) ?dt7))) (app (app arrT ?n8) ?dt7))) (typeOf %0 (app (app pairT (app (app arrT ?n8) ?dt6)) (app (app arrT ?n8) ?dt7)))) (app (app arrT ?n8) ?dt7))) (app (app arrT ?n8) ?dt6))) (app (app fun (app (app pairT (app (app arrT ?n6) ?dt4)) (app (app arrT ?n6) ?dt5))) (app (app arrT ?n6) ?dt4)))) (app (app fun (app (app arrT ?n7) (app (app pairT (app (app arrT ?n6) ?dt4)) (app (app arrT ?n6) ?dt5)))) (app (app arrT ?n7) (app (app arrT ?n6) ?dt4)))) (typeOf (app (typeOf (app (typeOf zip (app (app fun (app (app arrT ?n7) (app (app arrT ?n6) ?dt4))) (app (app fun (app (app arrT ?n7) (app (app arrT ?n6) ?dt5))) (app (app arrT ?n7) (app (app pairT (app (app arrT ?n6) ?dt4)) (app (app arrT ?n6) ?dt5)))))) (typeOf %1 (app (app arrT ?n7) (app (app arrT ?n6) ?dt4)))) (app (app fun (app (app arrT ?n7) (app (app arrT ?n6) ?dt5))) (app (app arrT ?n7) (app (app pairT (app (app arrT ?n6) ?dt4)) (app (app arrT ?n6) ?dt5))))) (typeOf %0 (app (app arrT ?n7) (app (app arrT ?n6) ?dt5)))) (app (app arrT ?n7) (app (app pairT (app (app arrT ?n6) ?dt4)) (app (app arrT ?n6) ?dt5))))) (app (app arrT ?n7) (app (app arrT ?n6) ?dt4)))) (app (app fun (app (app arrT ?n9) (app (app arrT ?n10) ?dt8))) (app (app arrT ?n9) (app (app arrT ?n10) ?dt9))))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) ?dt1))) (app (app arrT ?n5) (app (app arrT ?n0) ?dt0)))))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n5) (app (app arrT ?n0) ?dt1)))) (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))))) (typeOf (app (typeOf fst (app (app fun (app (app pairT (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n5) (app (app arrT ?n0) ?dt0)))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT ?n5) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app pairT (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1)))) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n5) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))))) (typeOf unzip (app (app fun (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1)))) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n5) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (typeOf %0 (app (app arrT ?n5) (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1)))))) (app (app arrT ?n5) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (app (app pairT (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (app (app arrT ?n5) (app (app arrT ?n0) ?dt0)))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n5) (app (app arrT ?n0) ?dt1)))) (app (app arrT ?n5) (app (app arrT ?n0) ?dt0)))) (typeOf (app (typeOf transpose (app (app fun (app (app arrT ?n5) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))) (app (app arrT ?n1) (app (app arrT ?n5) (app (app arrT ?n0) ?dt1))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n5) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))))) (typeOf transpose (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n5) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (typeOf (app (typeOf snd (app (app fun (app (app pairT (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT ?n5) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app pairT (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1)))) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n5) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))))) (typeOf unzip (app (app fun (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1)))) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (app (app fun (app (app arrT ?n5) (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n5) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (typeOf %0 (app (app arrT ?n5) (app (app arrT ?n0) (app (app pairT ?dt0) (app (app arrT ?n1) ?dt1)))))) (app (app arrT ?n5) (app (app pairT (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (app (app pairT (app (app arrT ?n5) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (app (app arrT ?n5) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n5) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (app (app arrT ?n1) (app (app arrT ?n5) (app (app arrT ?n0) ?dt1))))) (app (app arrT ?n5) (app (app arrT ?n0) ?dt0)))) (app (app fun (app (app arrT ?n4) (app (app arrT ?n2) (app (app pairT ?dt2) (app (app arrT ?n3) ?dt3))))) (app (app arrT ?n4) (app (app arrT ?n2) ?dt2))))"))))))))))))))))))) }),
    //     rw!("transpose-around-map-map-f-1m"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) ?) (typeOf ?e1 (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))" => "(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))))) (typeOf transpose (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt1))) (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (typeOf (app (typeOf map (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt1)))) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt1)))) (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))))) (typeOf transpose (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))))) (typeOf ?e1 (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))"),
    //     rw!("store-to-mem"; "(typeOf ?e0 ?dt0)" => { shifted("?dt0", "?dt1", 1, 0, pat("(typeOf (app (typeOf (app (typeOf let (app (app fun ?dt0) (app (app fun (app (app fun ?dt0) ?dt0)) ?dt0))) (typeOf (app (typeOf toMem (app (app fun ?dt0) ?dt0)) (typeOf ?e0 ?dt0)) ?dt0)) (app (app fun (app (app fun ?dt0) ?dt0)) ?dt0)) (typeOf (lam (typeOf %0 ?dt1)) (app (app fun ?dt0) ?dt0))) ?dt0)")) }),
    //     rw!("map-array"; "(typeOf ?e0 (app (app arrT ?n0) ?dt0))" => { shifted("?dt0", "?dt1", 1, 0, pat("(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun ?dt0) ?dt0)) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0)))) (typeOf (lam (typeOf %0 ?dt1)) (app (app fun ?dt0) ?dt0))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0))) (typeOf ?e0 (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) ?dt0))")) }),
    //     rw!("map-fusion"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e1 (app (app fun ?dt2) ?dt0))) ?) (typeOf ?e2 (app (app arrT ?n0) ?dt2))) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) ?dt1))" => { shifted("?1", "?4", 1, 0, shifted("?0", "?3", 1, 0, shifted("?dt1", "?dt4", 1, 0, shifted("?dt2", "?dt5", 1, 0, shifted("?dt0", "?dt3", 1, 0, pat("(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun ?dt2) ?dt1)) (app (app fun (app (app arrT ?n0) ?dt2)) (app (app arrT ?n0) ?dt1)))) (typeOf (lam (typeOf (app (typeOf ?e3 (app (app fun ?dt3) ?dt4)) (typeOf (app (typeOf ?e4 (app (app fun ?dt5) ?dt3)) (typeOf %0 ?dt5)) ?dt3)) ?dt4)) (app (app fun ?dt2) ?dt1))) (app (app fun (app (app arrT ?n0) ?dt2)) (app (app arrT ?n0) ?dt1))) (typeOf ?e2 (app (app arrT ?n0) ?dt2))) (app (app arrT ?n0) ?dt1))")))))) }),
    //     rw!("map-eta-abstraction"; "(typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1)))" => { shifted("?0", "?1", 1, 0, shifted("?n0", "?n1", 1, 0, shifted("?dt0", "?dt2", 1, 0, shifted("?dt1", "?dt3", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun ?dt2) ?dt3)) (app (app fun (app (app arrT ?n1) ?dt2)) (app (app arrT ?n1) ?dt3)))) (typeOf ?e1 (app (app fun ?dt2) ?dt3))) (app (app fun (app (app arrT ?n1) ?dt2)) (app (app arrT ?n1) ?dt3))) (typeOf %0 (app (app arrT ?n1) ?dt2))) (app (app arrT ?n1) ?dt3))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1)))"))))) }),
    //     rw!("vec-32-after-f32"; "(typeOf ?e0 (app (app arrT ?n0) f32))" => { shifted("?n0", "?n1", 1, 0, pat("(typeOf (app (typeOf asScalar (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app vecT 32) f32))) (app (app arrT ?n0) f32))) (typeOf (app (typeOf (app (typeOf asVector (lam (app (app fun (app (app arrT (app (app mul %0) (app (app mul (app (app pow 32) -1)) ?n1))) f32)) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n1)) (app (app vecT %0) f32))))) 32) (app (app fun (app (app arrT ?n0) f32)) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app vecT 32) f32)))) (typeOf ?e0 (app (app arrT ?n0) f32))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app vecT 32) f32)))) (app (app arrT ?n0) f32))")) }),
    //     rw!("vec-32-after-(f32, f32)"; "(typeOf ?e0 (app (app arrT ?n0) (app (app pairT f32) f32)))" => { shifted("?n0", "?n1", 1, 0, pat("(typeOf (app (typeOf asScalar (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app vecT 32) (app (app pairT f32) f32)))) (app (app arrT ?n0) (app (app pairT f32) f32)))) (typeOf (app (typeOf (app (typeOf asVector (lam (app (app fun (app (app arrT (app (app mul %0) (app (app mul (app (app pow 32) -1)) ?n1))) (app (app pairT f32) f32))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n1)) (app (app vecT %0) (app (app pairT f32) f32)))))) 32) (app (app fun (app (app arrT ?n0) (app (app pairT f32) f32))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app vecT 32) (app (app pairT f32) f32))))) (typeOf ?e0 (app (app arrT ?n0) (app (app pairT f32) f32)))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app vecT 32) (app (app pairT f32) f32))))) (app (app arrT ?n0) (app (app pairT f32) f32)))")) }),
    //     rw!("vec-32-after-(f32, (f32, f32))"; "(typeOf ?e0 (app (app arrT ?n0) (app (app pairT f32) (app (app pairT f32) f32))))" => { shifted("?n0", "?n1", 1, 0, pat("(typeOf (app (typeOf asScalar (app (app fun (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app vecT 32) (app (app pairT f32) (app (app pairT f32) f32))))) (app (app arrT ?n0) (app (app pairT f32) (app (app pairT f32) f32))))) (typeOf (app (typeOf (app (typeOf asVector (lam (app (app fun (app (app arrT (app (app mul %0) (app (app mul (app (app pow 32) -1)) ?n1))) (app (app pairT f32) (app (app pairT f32) f32)))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n1)) (app (app vecT %0) (app (app pairT f32) (app (app pairT f32) f32))))))) 32) (app (app fun (app (app arrT ?n0) (app (app pairT f32) (app (app pairT f32) f32)))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app vecT 32) (app (app pairT f32) (app (app pairT f32) f32)))))) (typeOf ?e0 (app (app arrT ?n0) (app (app pairT f32) (app (app pairT f32) f32))))) (app (app arrT (app (app mul (app (app pow 32) -1)) ?n0)) (app (app vecT 32) (app (app pairT f32) (app (app pairT f32) f32)))))) (app (app arrT ?n0) (app (app pairT f32) (app (app pairT f32) f32))))")) }),
    //     rw!("vec-before-map-f32"; "(typeOf (app (typeOf (app (typeOf asVector ?) ?n0) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun f32) f32))) ?) (typeOf ?e1 (app (app arrT ?n1) f32))) (app (app arrT ?n2) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))" => { vectorize_scalar_fun("?0", "?n0", "?2", shifted("?n3", "?n4", 1, 0, compute_nat_check("?n1", "(app (app mul ?n3) ?n0)", compute_nat_check("?n2", "(app (app mul ?n3) ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))) (app (app fun (app (app arrT ?n3) (app (app vecT ?n0) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32))))) (typeOf ?e2 (app (app fun (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))) (app (app fun (app (app arrT ?n3) (app (app vecT ?n0) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (typeOf (app (typeOf (app (typeOf asVector (lam (app (app fun (app (app arrT (app (app mul %0) ?n4)) f32)) (app (app arrT ?n4) (app (app vecT %0) f32))))) ?n0) (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (typeOf ?e1 (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))"))))) }),
    //     rw!("vec-before-map-f32xf32"; "(typeOf (app (typeOf (app (typeOf asVector ?) ?n0) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun (app (app pairT f32) f32)) f32))) ?) (typeOf ?e1 (app (app arrT ?n1) (app (app pairT f32) f32)))) (app (app arrT ?n2) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))" => { vectorize_scalar_fun("?0", "?n0", "?2", shifted("?n3", "?n4", 1, 0, compute_nat_check("?n1", "(app (app mul ?n3) ?n0)", compute_nat_check("?n2", "(app (app mul ?n3) ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))) (app (app vecT ?n0) f32))) (app (app fun (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))) (app (app arrT ?n3) (app (app vecT ?n0) f32))))) (typeOf ?e2 (app (app fun (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))) (app (app vecT ?n0) f32)))) (app (app fun (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (typeOf (app (typeOf (app (typeOf zip (app (app fun (app (app arrT ?n3) (app (app vecT ?n0) f32))) (app (app fun (app (app arrT ?n3) (app (app vecT ?n0) f32))) (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))))) (typeOf (app (typeOf (app (typeOf asVector (lam (app (app fun (app (app arrT (app (app mul %0) ?n4)) f32)) (app (app arrT ?n4) (app (app vecT %0) f32))))) ?n0) (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (typeOf (app (typeOf fst (app (app fun (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32)))) (typeOf ?e1 (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32)))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32)))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (app (app fun (app (app arrT ?n3) (app (app vecT ?n0) f32))) (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))))) (typeOf (app (typeOf (app (typeOf asVector (lam (app (app fun (app (app arrT (app (app mul %0) ?n4)) f32)) (app (app arrT ?n4) (app (app vecT %0) f32))))) ?n0) (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (typeOf (app (typeOf snd (app (app fun (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32)))) (typeOf ?e1 (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32)))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32)))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))"))))) }),
    //     rw!("vec-before-map-f32x-f32xf32"; "(typeOf (app (typeOf (app (typeOf asVector ?) ?n0) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun (app (app pairT f32) (app (app pairT f32) f32))) f32))) ?) (typeOf ?e1 (app (app arrT ?n1) (app (app pairT f32) (app (app pairT f32) f32))))) (app (app arrT ?n2) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))" => { vectorize_scalar_fun("?0", "?n0", "?2", shifted("?n3", "?n4", 1, 0, compute_nat_check("?n1", "(app (app mul ?n3) ?n0)", compute_nat_check("?n2", "(app (app mul ?n3) ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app pairT (app (app vecT ?n0) f32)) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))) (app (app vecT ?n0) f32))) (app (app fun (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))))) (app (app arrT ?n3) (app (app vecT ?n0) f32))))) (typeOf ?e2 (app (app fun (app (app pairT (app (app vecT ?n0) f32)) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))) (app (app vecT ?n0) f32)))) (app (app fun (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (typeOf (app (typeOf (app (typeOf zip (app (app fun (app (app arrT ?n3) (app (app vecT ?n0) f32))) (app (app fun (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))) (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))))))) (typeOf (app (typeOf (app (typeOf asVector (lam (app (app fun (app (app arrT (app (app mul %0) ?n4)) f32)) (app (app arrT ?n4) (app (app vecT %0) f32))))) ?n0) (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (typeOf (app (typeOf fst (app (app fun (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32)))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) (app (app pairT f32) f32)))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))))) (typeOf ?e1 (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) (app (app pairT f32) f32))))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (app (app fun (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))) (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))))) (typeOf (app (typeOf (app (typeOf zip (app (app fun (app (app arrT ?n3) (app (app vecT ?n0) f32))) (app (app fun (app (app arrT ?n3) (app (app vecT ?n0) f32))) (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))))) (typeOf (app (typeOf (app (typeOf asVector (lam (app (app fun (app (app arrT (app (app mul %0) ?n4)) f32)) (app (app arrT ?n4) (app (app vecT %0) f32))))) ?n0) (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (typeOf (app (typeOf fst (app (app fun (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32)))) (typeOf (app (typeOf snd (app (app fun (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32)))) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32)))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) (app (app pairT f32) f32)))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))))) (typeOf ?e1 (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) (app (app pairT f32) f32))))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))))) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32)))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32)))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (app (app fun (app (app arrT ?n3) (app (app vecT ?n0) f32))) (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))))) (typeOf (app (typeOf (app (typeOf asVector (lam (app (app fun (app (app arrT (app (app mul %0) ?n4)) f32)) (app (app arrT ?n4) (app (app vecT %0) f32))))) ?n0) (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (typeOf (app (typeOf snd (app (app fun (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32)))) (typeOf (app (typeOf snd (app (app fun (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32)))) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32)))) (typeOf (app (typeOf unzip (app (app fun (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) (app (app pairT f32) f32)))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))))) (typeOf ?e1 (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) (app (app pairT f32) f32))))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32))))) (app (app arrT (app (app mul ?n3) ?n0)) (app (app pairT f32) f32)))) (app (app pairT (app (app arrT (app (app mul ?n3) ?n0)) f32)) (app (app arrT (app (app mul ?n3) ?n0)) f32)))) (app (app arrT (app (app mul ?n3) ?n0)) f32))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))) (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32))))) (app (app arrT ?n3) (app (app pairT (app (app vecT ?n0) f32)) (app (app pairT (app (app vecT ?n0) f32)) (app (app vecT ?n0) f32)))))) (app (app arrT ?n3) (app (app vecT ?n0) f32)))"))))) }),
    //     rw!("reduce-seq-unroll"; "(typeOf reduceSeq (app (app fun (app (app fun ?dt0) (app (app fun ?dt1) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt1)) ?dt0))))" => "(typeOf reduceSeqUnroll (app (app fun (app (app fun ?dt0) (app (app fun ?dt1) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt1)) ?dt0))))"),
    //     rw!("map-par"; "(typeOf map (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1))))" => "(typeOf mapPar (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1))))"),
    // ];
    let mut algorithmic = vec![
        rewrite!("map-fission"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf (app (typeOf ?e0 ?) (typeOf ?e1 ?dt0)) ?)) (fun ?dt1 ?dt2))) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt2)))" => { NotFreeIn::new("?0", 0, Shifted::new("?1", "?2", 1, 1, Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt1", "?dt4", 1, 0, Shifted::new("?dt2", "?dt3", 1, 0, Shifted::new("?dt0", "?dt5", 1, 1, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun ?dt0 ?dt3) (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt3)))) (typeOf ?e0 (fun ?dt0 ?dt3))) (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt3))) (typeOf (app (typeOf (app (typeOf map (fun (fun ?dt4 ?dt0) (fun (arrT ?n1 ?dt4) (arrT ?n1 ?dt0)))) (typeOf (lam (typeOf ?e2 ?dt5)) (fun ?dt4 ?dt0))) (fun (arrT ?n1 ?dt4) (arrT ?n1 ?dt0))) (typeOf %0 (arrT ?n1 ?dt4))) (arrT ?n1 ?dt0))) (arrT ?n1 ?dt3))) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt2)))"))))))) }),
        rewrite!("reduce-seq"; "(typeOf reduce (fun (fun ?dt0 (fun ?dt0 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt0) ?dt0))))" => { pat("(typeOf reduceSeq (fun (fun ?dt0 (fun ?dt0 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt0) ?dt0))))") }),
        rewrite!("eliminate-map-identity"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf %0 ?)) (fun ?dt0 ?dt0))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0)))" => { Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt0", "?dt1", 1, 0, pat("(typeOf (lam (typeOf %0 (arrT ?n1 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0)))"))) }),
        rewrite!("reduce-seq-map-fusion"; "(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf ?e0 (fun ?dt0 (fun ?dt1 ?dt0)))) ?) (typeOf ?e1 ?dt0)) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e2 (fun ?dt2 ?dt1))) ?) (typeOf ?e3 (arrT ?n0 ?dt2))) (arrT ?n0 ?dt1))) ?dt0)" => { Shifted::new("?2", "?5", 2, 0, Shifted::new("?0", "?4", 2, 0, Shifted::new("?dt2", "?dt5", 2, 0, Shifted::new("?dt2", "?dt6", 1, 0, Shifted::new("?dt1", "?dt4", 2, 0, Shifted::new("?dt0", "?dt3", 2, 0, Shifted::new("?dt0", "?dt7", 1, 0, pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun ?dt0 (fun ?dt2 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt2) ?dt0)))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e4 (fun ?dt3 (fun ?dt4 ?dt3))) (typeOf %1 ?dt3)) (fun ?dt4 ?dt3)) (typeOf (app (typeOf ?e5 (fun ?dt5 ?dt4)) (typeOf %0 ?dt5)) ?dt4)) ?dt3)) (fun ?dt6 ?dt7))) (fun ?dt0 (fun ?dt2 ?dt0)))) (fun ?dt0 (fun (arrT ?n0 ?dt2) ?dt0))) (typeOf ?e1 ?dt0)) (fun (arrT ?n0 ?dt2) ?dt0)) (typeOf ?e3 (arrT ?n0 ?dt2))) ?dt0)")))))))) }),
        rewrite!("split-join-32"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (fun ?dt0 ?dt1))) ?) (typeOf ?e1 (arrT ?n0 ?dt0))) (arrT ?n0 ?dt1))" => { Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt0", "?dt2", 1, 0, pat("(typeOf (app (typeOf join (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)) (arrT ?n0 ?dt1))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT 32 ?dt0) (arrT 32 ?dt1)) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (typeOf ?e0 (fun ?dt0 ?dt1))) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (typeOf (app (typeOf (app (typeOf split (lam (fun (arrT (natMul %0 (natMul (natPow 32 -1) ?n1)) ?dt2) (arrT (natMul (natPow 32 -1) ?n1) (arrT %0 ?dt2))))) 32) (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (typeOf ?e1 (arrT ?n0 ?dt0))) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (arrT ?n0 ?dt1))"))) }),
        rewrite!("split-join-2m-32"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf ?e0 (fun ?dt0 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT ?n0 ?dt1))))) ?) (typeOf ?e1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))" => { Shifted::new("?n0", "?n3", 1, 0, Shifted::new("?dt0", "?dt2", 1, 0, pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1)))))) (typeOf (app (typeOf map (fun (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)) (arrT ?n0 ?dt1)) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf join (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)) (arrT ?n0 ?dt1)))) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))))) (typeOf (app (typeOf map (fun (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (typeOf (app (typeOf map (fun (fun (arrT 32 ?dt0) (arrT 32 ?dt1)) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (typeOf ?e0 (fun ?dt0 ?dt1))) (fun (arrT 32 ?dt0) (arrT 32 ?dt1)))) (fun (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1))))) (fun (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))))))) (typeOf (app (typeOf map (fun (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (typeOf (app (typeOf split (lam (fun (arrT (natMul %0 (natMul (natPow 32 -1) ?n3)) ?dt2) (arrT (natMul (natPow 32 -1) ?n3) (arrT %0 ?dt2))))) 32) (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0))))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (typeOf ?e1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt0)))))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32 -1) ?n0) (arrT 32 ?dt1)))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))"))) }),
        rewrite!("blocked-reduce-4"; "(typeOf (app (typeOf (app (typeOf (app (typeOf reduce ?) (typeOf ?e0 (fun ?dt0 (fun ?dt0 ?dt0)))) ?) (typeOf ?e1 ?dt0)) ?) (typeOf ?e2 (arrT ?n0 ?dt0))) ?dt0)" => { Shifted::new("?1", "?4", 2, 0, Shifted::new("?0", "?3", 2, 0, Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt0", "?dt1", 2, 0, Shifted::new("?dt0", "?dt2", 1, 0, pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun ?dt0 (fun (arrT 4 ?dt0) ?dt0)) (fun ?dt0 (fun (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)) ?dt0)))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e3 (fun ?dt1 (fun ?dt1 ?dt1))) (typeOf %1 ?dt1)) (fun ?dt1 ?dt1)) (typeOf (app (typeOf (app (typeOf (app (typeOf reduce (fun (fun ?dt1 (fun ?dt1 ?dt1)) (fun ?dt1 (fun (arrT 4 ?dt1) ?dt1)))) (typeOf ?e3 (fun ?dt1 (fun ?dt1 ?dt1)))) (fun ?dt1 (fun (arrT 4 ?dt1) ?dt1))) (typeOf ?e4 ?dt1)) (fun (arrT 4 ?dt1) ?dt1)) (typeOf %0 (arrT 4 ?dt1))) ?dt1)) ?dt1)) (fun (arrT 4 ?dt2) ?dt2))) (fun ?dt0 (fun (arrT 4 ?dt0) ?dt0)))) (fun ?dt0 (fun (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)) ?dt0))) (typeOf ?e1 ?dt0)) (fun (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)) ?dt0)) (typeOf (app (typeOf (app (typeOf split (lam (fun (arrT (natMul %0 (natMul (natPow 4 -1) ?n1)) ?dt2) (arrT (natMul (natPow 4 -1) ?n1) (arrT %0 ?dt2))))) 4) (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)))) (typeOf ?e2 (arrT ?n0 ?dt0))) (arrT (natMul (natPow 4 -1) ?n0) (arrT 4 ?dt0)))) ?dt0)")))))) }),
        rewrite!("split-before-map"; "(typeOf (app (typeOf (app (typeOf split ?) ?n0) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (fun ?dt0 ?dt1))) ?) (typeOf ?e1 (arrT ?n1 ?dt0))) (arrT ?n2 ?dt1))) (arrT ?n3 (arrT ?n0 ?dt1)))" => { Shifted::new("?n3", "?n4", 1, 0, Shifted::new("?dt0", "?dt2", 1, 0, ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)) (fun (arrT ?n3 (arrT ?n0 ?dt0)) (arrT ?n3 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) (typeOf ?e0 (fun ?dt0 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) (fun (arrT ?n3 (arrT ?n0 ?dt0)) (arrT ?n3 (arrT ?n0 ?dt1)))) (typeOf (app (typeOf (app (typeOf split (lam (fun (arrT (natMul %0 ?n4) ?dt2) (arrT ?n4 (arrT %0 ?dt2))))) ?n0) (fun (arrT (natMul ?n3 ?n0) ?dt0) (arrT ?n3 (arrT ?n0 ?dt0)))) (typeOf ?e1 (arrT (natMul ?n3 ?n0) ?dt0))) (arrT ?n3 (arrT ?n0 ?dt0)))) (arrT ?n3 (arrT ?n0 ?dt1)))"))))) }),
        rewrite!("reduce-seq-map-fission"; "(typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e0 ?) (typeOf %1 ?dt0)) ?) (typeOf ?e1 ?dt1)) ?)) ?)) (fun ?dt2 (fun ?dt3 ?dt2)))) ?) (typeOf ?e2 ?dt2)) (fun (arrT ?n0 ?dt3) ?dt2))" => { NotFreeIn::new("?0", 0, Shifted::new("?2", "?4", 1, 0, Shifted::new("?0", "?3", -1, 2, Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt3", "?dt6", 1, 0, ShiftedCheck::new("?dt2", "?dt0", 2, 0, Shifted::new("?dt2", "?dt4", 1, 0, Shifted::new("?dt1", "?dt5", -1, 2, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun ?dt4 (fun ?dt5 ?dt4)) (fun ?dt4 (fun (arrT ?n1 ?dt5) ?dt4)))) (typeOf ?e3 (fun ?dt4 (fun ?dt5 ?dt4)))) (fun ?dt4 (fun (arrT ?n1 ?dt5) ?dt4))) (typeOf ?e4 ?dt4)) (fun (arrT ?n1 ?dt5) ?dt4)) (typeOf (app (typeOf (app (typeOf map (fun (fun ?dt6 ?dt5) (fun (arrT ?n1 ?dt6) (arrT ?n1 ?dt5)))) (typeOf (lam (typeOf ?e1 ?dt1)) (fun ?dt6 ?dt5))) (fun (arrT ?n1 ?dt6) (arrT ?n1 ?dt5))) (typeOf %0 (arrT ?n1 ?dt6))) (arrT ?n1 ?dt5))) ?dt4)) (fun (arrT ?n0 ?dt3) ?dt2))"))))))))) }),
        rewrite!("lift-reduce-seq"; "(typeOf (app (typeOf map ?) (typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf ?e0 (fun ?dt0 (fun ?dt1 ?dt0)))) ?) (typeOf ?e1 ?dt0)) (fun (arrT ?n0 ?dt1) ?dt0))) (fun (arrT ?n1 (arrT ?n0 ?dt1)) (arrT ?n1 ?dt0)))" => { Shifted::new("?1", "?3", 2, 0, Shifted::new("?0", "?2", 4, 0, Shifted::new("?n0", "?n3", 1, 0, Shifted::new("?n1", "?n4", 3, 0, Shifted::new("?n1", "?n5", 2, 0, Shifted::new("?n1", "?n2", 1, 0, Shifted::new("?dt1", "?dt7", 4, 0, Shifted::new("?dt1", "?dt5", 3, 0, Shifted::new("?dt1", "?dt8", 2, 0, Shifted::new("?dt1", "?dt3", 1, 0, Shifted::new("?dt0", "?dt6", 4, 0, Shifted::new("?dt0", "?dt4", 3, 0, Shifted::new("?dt0", "?dt9", 2, 0, Shifted::new("?dt0", "?dt2", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun (arrT ?n2 ?dt2) (fun (arrT ?n2 ?dt3) (arrT ?n2 ?dt2))) (fun (arrT ?n2 ?dt2) (fun (arrT ?n3 (arrT ?n2 ?dt3)) (arrT ?n2 ?dt2))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun (pairT ?dt4 ?dt5) ?dt4) (fun (arrT ?n4 (pairT ?dt4 ?dt5)) (arrT ?n4 ?dt4)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e2 (fun ?dt6 (fun ?dt7 ?dt6))) (typeOf (app (typeOf fst (fun (pairT ?dt6 ?dt7) ?dt6)) (typeOf %0 (pairT ?dt6 ?dt7))) ?dt6)) (fun ?dt7 ?dt6)) (typeOf (app (typeOf snd (fun (pairT ?dt6 ?dt7) ?dt7)) (typeOf %0 (pairT ?dt6 ?dt7))) ?dt7)) ?dt6)) (fun (pairT ?dt4 ?dt5) ?dt4))) (fun (arrT ?n4 (pairT ?dt4 ?dt5)) (arrT ?n4 ?dt4))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n4 ?dt4) (fun (arrT ?n4 ?dt5) (arrT ?n4 (pairT ?dt4 ?dt5))))) (typeOf %1 (arrT ?n4 ?dt4))) (fun (arrT ?n4 ?dt5) (arrT ?n4 (pairT ?dt4 ?dt5)))) (typeOf %0 (arrT ?n4 ?dt5))) (arrT ?n4 (pairT ?dt4 ?dt5)))) (arrT ?n4 ?dt4))) (fun (arrT ?n5 ?dt8) (arrT ?n5 ?dt9)))) (fun (arrT ?n2 ?dt2) (fun (arrT ?n2 ?dt3) (arrT ?n2 ?dt2))))) (fun (arrT ?n2 ?dt2) (fun (arrT ?n3 (arrT ?n2 ?dt3)) (arrT ?n2 ?dt2)))) (typeOf (app (typeOf generate (fun (fun (idxT ?n2) ?dt2) (arrT ?n2 ?dt2))) (typeOf (lam (typeOf ?e3 ?dt9)) (fun (idxT ?n2) ?dt2))) (arrT ?n2 ?dt2))) (fun (arrT ?n3 (arrT ?n2 ?dt3)) (arrT ?n2 ?dt2))) (typeOf (app (typeOf transpose (fun (arrT ?n2 (arrT ?n3 ?dt3)) (arrT ?n3 (arrT ?n2 ?dt3)))) (typeOf %0 (arrT ?n2 (arrT ?n3 ?dt3)))) (arrT ?n3 (arrT ?n2 ?dt3)))) (arrT ?n2 ?dt2))) (fun (arrT ?n1 (arrT ?n0 ?dt1)) (arrT ?n1 ?dt0)))"))))))))))))))) }),
        rewrite!("lift-reduce-seq-2"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf (app (typeOf (app (typeOf add ?) (typeOf (app (typeOf fst ?) (typeOf %0 (pairT f32 (arrT ?n0 ?dt0)))) f32)) ?) (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf ?e0 (fun f32 (fun ?dt0 f32)))) ?) (typeOf 0.0 f32)) ?) (typeOf (app (typeOf snd ?) (typeOf %0 (pairT f32 (arrT ?n0 ?dt0)))) (arrT ?n0 ?dt0))) f32)) ?)) (fun (pairT f32 (arrT ?n1 ?dt1)) f32))) (fun (arrT ?n2 (pairT f32 (arrT ?n1 ?dt1))) (arrT ?n2 f32)))" => { Shifted::new("?0", "?1", 4, 1, Shifted::new("?n1", "?n4", 2, 0, ShiftedCheck::new("?n1", "?n0", 1, 0, Shifted::new("?n2", "?n5", 4, 0, Shifted::new("?n2", "?n6", 3, 0, Shifted::new("?n2", "?n3", 2, 0, Shifted::new("?n2", "?n7", 1, 0, Shifted::new("?dt1", "?dt4", 5, 0, Shifted::new("?dt1", "?dt3", 4, 0, Shifted::new("?dt1", "?dt5", 3, 0, Shifted::new("?dt1", "?dt2", 2, 0, ShiftedCheck::new("?dt1", "?dt0", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun (arrT ?n3 f32) (fun (arrT ?n3 ?dt2) (arrT ?n3 f32))) (fun (arrT ?n3 f32) (fun (arrT ?n4 (arrT ?n3 ?dt2)) (arrT ?n3 f32))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun (pairT f32 ?dt3) f32) (fun (arrT ?n5 (pairT f32 ?dt3)) (arrT ?n5 f32)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e1 (fun f32 (fun ?dt4 f32))) (typeOf (app (typeOf fst (fun (pairT f32 ?dt4) f32)) (typeOf %0 (pairT f32 ?dt4))) f32)) (fun ?dt4 f32)) (typeOf (app (typeOf snd (fun (pairT f32 ?dt4) ?dt4)) (typeOf %0 (pairT f32 ?dt4))) ?dt4)) f32)) (fun (pairT f32 ?dt3) f32))) (fun (arrT ?n5 (pairT f32 ?dt3)) (arrT ?n5 f32))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n5 f32) (fun (arrT ?n5 ?dt3) (arrT ?n5 (pairT f32 ?dt3))))) (typeOf %1 (arrT ?n5 f32))) (fun (arrT ?n5 ?dt3) (arrT ?n5 (pairT f32 ?dt3)))) (typeOf %0 (arrT ?n5 ?dt3))) (arrT ?n5 (pairT f32 ?dt3)))) (arrT ?n5 f32))) (fun (arrT ?n6 ?dt5) (arrT ?n6 f32)))) (fun (arrT ?n3 f32) (fun (arrT ?n3 ?dt2) (arrT ?n3 f32))))) (fun (arrT ?n3 f32) (fun (arrT ?n4 (arrT ?n3 ?dt2)) (arrT ?n3 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT ?n3 f32) (arrT ?n3 (arrT ?n4 ?dt2))) (arrT ?n3 f32))) (typeOf %0 (pairT (arrT ?n3 f32) (arrT ?n3 (arrT ?n4 ?dt2))))) (arrT ?n3 f32))) (fun (arrT ?n4 (arrT ?n3 ?dt2)) (arrT ?n3 f32))) (typeOf (app (typeOf transpose (fun (arrT ?n3 (arrT ?n4 ?dt2)) (arrT ?n4 (arrT ?n3 ?dt2)))) (typeOf (app (typeOf snd (fun (pairT (arrT ?n3 f32) (arrT ?n3 (arrT ?n4 ?dt2))) (arrT ?n3 (arrT ?n4 ?dt2)))) (typeOf %0 (pairT (arrT ?n3 f32) (arrT ?n3 (arrT ?n4 ?dt2))))) (arrT ?n3 (arrT ?n4 ?dt2)))) (arrT ?n4 (arrT ?n3 ?dt2)))) (arrT ?n3 f32))) (fun (pairT (arrT ?n7 f32) (arrT ?n7 (arrT ?n0 ?dt0))) (arrT ?n7 f32))) (typeOf (app (typeOf unzip (fun (arrT ?n7 (pairT f32 (arrT ?n0 ?dt0))) (pairT (arrT ?n7 f32) (arrT ?n7 (arrT ?n0 ?dt0))))) (typeOf %0 (arrT ?n7 (pairT f32 (arrT ?n0 ?dt0))))) (pairT (arrT ?n7 f32) (arrT ?n7 (arrT ?n0 ?dt0))))) (arrT ?n7 f32))) (fun (arrT ?n2 (pairT f32 (arrT ?n1 ?dt1))) (arrT ?n2 f32)))"))))))))))))) }),
        rewrite!("lift-reduce-seq-3"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?) (typeOf ?e0 (fun (arrT ?n0 ?dt0) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt0))))) ?) (typeOf (app (typeOf fst ?) (typeOf (app (typeOf unzip ?) (typeOf %0 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n0 ?dt0))) ?) (typeOf (app (typeOf transpose ?) (typeOf (app (typeOf snd ?) (typeOf (app (typeOf unzip ?) (typeOf %0 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n1 (arrT ?n0 ?dt1)))) ?)) (fun (arrT ?n2 (pairT ?dt2 (arrT ?n3 ?dt3))) (arrT ?n2 ?dt2)))) (fun (arrT ?n4 (arrT ?n2 (pairT ?dt2 (arrT ?n3 ?dt3)))) (arrT ?n4 (arrT ?n2 ?dt2))))" => { NotFreeIn::new("?0", 0, Shifted::new("?0", "?1", 3, 1, ShiftedCheck::new("?n3", "?n1", 1, 0, Shifted::new("?n2", "?n8", 4, 0, Shifted::new("?n2", "?n6", 3, 0, Shifted::new("?n2", "?n10", 2, 0, ShiftedCheck::new("?n2", "?n0", 1, 0, Shifted::new("?n4", "?n7", 3, 0, Shifted::new("?n4", "?n9", 2, 0, Shifted::new("?n4", "?n5", 1, 0, Shifted::new("?dt2", "?dt6", 4, 0, Shifted::new("?dt2", "?dt4", 3, 0, Shifted::new("?dt2", "?dt9", 2, 0, ShiftedCheck::new("?dt2", "?dt0", 1, 0, Shifted::new("?dt3", "?dt7", 4, 0, Shifted::new("?dt3", "?dt5", 3, 0, Shifted::new("?dt3", "?dt8", 2, 0, ShiftedCheck::new("?dt3", "?dt1", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun (arrT ?n5 (arrT ?n0 ?dt0)) (fun (arrT ?n5 (arrT ?n0 ?dt1)) (arrT ?n5 (arrT ?n0 ?dt0)))) (fun (arrT ?n5 (arrT ?n0 ?dt0)) (fun (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))) (arrT ?n5 (arrT ?n0 ?dt0)))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5)) (arrT ?n6 ?dt4)) (fun (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5))) (arrT ?n7 (arrT ?n6 ?dt4))))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?e1 (fun (arrT ?n8 ?dt6) (fun (arrT ?n8 ?dt7) (arrT ?n8 ?dt6)))) (typeOf (app (typeOf fst (fun (pairT (arrT ?n8 ?dt6) (arrT ?n8 ?dt7)) (arrT ?n8 ?dt6))) (typeOf %0 (pairT (arrT ?n8 ?dt6) (arrT ?n8 ?dt7)))) (arrT ?n8 ?dt6))) (fun (arrT ?n8 ?dt7) (arrT ?n8 ?dt6))) (typeOf (app (typeOf snd (fun (pairT (arrT ?n8 ?dt6) (arrT ?n8 ?dt7)) (arrT ?n8 ?dt7))) (typeOf %0 (pairT (arrT ?n8 ?dt6) (arrT ?n8 ?dt7)))) (arrT ?n8 ?dt7))) (arrT ?n8 ?dt6))) (fun (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5)) (arrT ?n6 ?dt4)))) (fun (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5))) (arrT ?n7 (arrT ?n6 ?dt4)))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n7 (arrT ?n6 ?dt4)) (fun (arrT ?n7 (arrT ?n6 ?dt5)) (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5)))))) (typeOf %1 (arrT ?n7 (arrT ?n6 ?dt4)))) (fun (arrT ?n7 (arrT ?n6 ?dt5)) (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5))))) (typeOf %0 (arrT ?n7 (arrT ?n6 ?dt5)))) (arrT ?n7 (pairT (arrT ?n6 ?dt4) (arrT ?n6 ?dt5))))) (arrT ?n7 (arrT ?n6 ?dt4)))) (fun (arrT ?n9 (arrT ?n10 ?dt8)) (arrT ?n9 (arrT ?n10 ?dt9))))) (fun (arrT ?n5 (arrT ?n0 ?dt0)) (fun (arrT ?n5 (arrT ?n0 ?dt1)) (arrT ?n5 (arrT ?n0 ?dt0)))))) (fun (arrT ?n5 (arrT ?n0 ?dt0)) (fun (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))) (arrT ?n5 (arrT ?n0 ?dt0))))) (typeOf (app (typeOf fst (fun (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n5 (arrT ?n0 ?dt0)))) (typeOf (app (typeOf unzip (fun (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (fun (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))))) (typeOf unzip (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (fun (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf %0 (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))))) (arrT ?n5 (arrT ?n0 ?dt0)))) (fun (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))) (arrT ?n5 (arrT ?n0 ?dt0)))) (typeOf (app (typeOf transpose (fun (arrT ?n5 (arrT ?n1 (arrT ?n0 ?dt1))) (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n5 (arrT ?n1 (arrT ?n0 ?dt1)))))) (typeOf transpose (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))))) (fun (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n5 (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf snd (fun (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1))))) (typeOf (app (typeOf unzip (fun (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (fun (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))))) (typeOf unzip (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (fun (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf %0 (arrT ?n5 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))))) (arrT ?n5 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (pairT (arrT ?n5 (arrT ?n0 ?dt0)) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1)))))) (arrT ?n5 (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n5 (arrT ?n1 (arrT ?n0 ?dt1))))) (arrT ?n1 (arrT ?n5 (arrT ?n0 ?dt1))))) (arrT ?n5 (arrT ?n0 ?dt0)))) (fun (arrT ?n4 (arrT ?n2 (pairT ?dt2 (arrT ?n3 ?dt3)))) (arrT ?n4 (arrT ?n2 ?dt2))))"))))))))))))))))))) }),
        rewrite!("transpose-around-map-map-f-1m"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf ?e0 (fun ?dt0 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT ?n0 ?dt1))))) ?) (typeOf ?e1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))" => { pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1)))))) (typeOf transpose (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1)))))) (typeOf (app (typeOf map (fun (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt1)) (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt1))))) (typeOf (app (typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt1)))) (typeOf ?e0 (fun ?dt0 ?dt1))) (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt1)))) (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt1))))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt0))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0)))))) (typeOf transpose (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt0))))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))))) (typeOf ?e1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))") }),
        rewrite!("store-to-mem"; "(typeOf ?e0 ?dt0)" => { Shifted::new("?dt0", "?dt1", 1, 0, pat("(typeOf (app (typeOf (app (typeOf let (fun ?dt0 (fun (fun ?dt0 ?dt0) ?dt0))) (typeOf (app (typeOf toMem (fun ?dt0 ?dt0)) (typeOf ?e0 ?dt0)) ?dt0)) (fun (fun ?dt0 ?dt0) ?dt0)) (typeOf (lam (typeOf %0 ?dt1)) (fun ?dt0 ?dt0))) ?dt0)")) }),
        rewrite!("map-array"; "(typeOf ?e0 (arrT ?n0 ?dt0))" => { Shifted::new("?dt0", "?dt1", 1, 0, pat("(typeOf (app (typeOf (app (typeOf map (fun (fun ?dt0 ?dt0) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0)))) (typeOf (lam (typeOf %0 ?dt1)) (fun ?dt0 ?dt0))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0))) (typeOf ?e0 (arrT ?n0 ?dt0))) (arrT ?n0 ?dt0))")) }),
        rewrite!("map-fusion"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (fun ?dt0 ?dt1))) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e1 (fun ?dt2 ?dt0))) ?) (typeOf ?e2 (arrT ?n0 ?dt2))) (arrT ?n0 ?dt0))) (arrT ?n0 ?dt1))" => { Shifted::new("?1", "?4", 1, 0, Shifted::new("?0", "?3", 1, 0, Shifted::new("?dt1", "?dt4", 1, 0, Shifted::new("?dt2", "?dt5", 1, 0, Shifted::new("?dt0", "?dt3", 1, 0, pat("(typeOf (app (typeOf (app (typeOf map (fun (fun ?dt2 ?dt1) (fun (arrT ?n0 ?dt2) (arrT ?n0 ?dt1)))) (typeOf (lam (typeOf (app (typeOf ?e3 (fun ?dt3 ?dt4)) (typeOf (app (typeOf ?e4 (fun ?dt5 ?dt3)) (typeOf %0 ?dt5)) ?dt3)) ?dt4)) (fun ?dt2 ?dt1))) (fun (arrT ?n0 ?dt2) (arrT ?n0 ?dt1))) (typeOf ?e2 (arrT ?n0 ?dt2))) (arrT ?n0 ?dt1))")))))) }),
        rewrite!("map-eta-abstraction"; "(typeOf (app (typeOf map ?) (typeOf ?e0 (fun ?dt0 ?dt1))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))" => { Shifted::new("?0", "?1", 1, 0, Shifted::new("?n0", "?n1", 1, 0, Shifted::new("?dt0", "?dt2", 1, 0, Shifted::new("?dt1", "?dt3", 1, 0, pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun ?dt2 ?dt3) (fun (arrT ?n1 ?dt2) (arrT ?n1 ?dt3)))) (typeOf ?e1 (fun ?dt2 ?dt3))) (fun (arrT ?n1 ?dt2) (arrT ?n1 ?dt3))) (typeOf %0 (arrT ?n1 ?dt2))) (arrT ?n1 ?dt3))) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))"))))) }),
        rewrite!("vec-32-after-f32"; "(typeOf ?e0 (arrT ?n0 f32))" => { Shifted::new("?n0", "?n1", 1, 0, pat("(typeOf (app (typeOf asScalar (fun (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 f32)) (arrT ?n0 f32))) (typeOf (app (typeOf (app (typeOf asVector (lam (fun (arrT (natMul %0 (natMul (natPow 32 -1) ?n1)) f32) (arrT (natMul (natPow 32 -1) ?n1) (vecT %0 f32))))) 32) (fun (arrT ?n0 f32) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 f32)))) (typeOf ?e0 (arrT ?n0 f32))) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 f32)))) (arrT ?n0 f32))")) }),
        rewrite!("vec-32-after-(f32, f32)"; "(typeOf ?e0 (arrT ?n0 (pairT f32 f32)))" => { Shifted::new("?n0", "?n1", 1, 0, pat("(typeOf (app (typeOf asScalar (fun (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 f32))) (arrT ?n0 (pairT f32 f32)))) (typeOf (app (typeOf (app (typeOf asVector (lam (fun (arrT (natMul %0 (natMul (natPow 32 -1) ?n1)) (pairT f32 f32)) (arrT (natMul (natPow 32 -1) ?n1) (vecT %0 (pairT f32 f32)))))) 32) (fun (arrT ?n0 (pairT f32 f32)) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 f32))))) (typeOf ?e0 (arrT ?n0 (pairT f32 f32)))) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 f32))))) (arrT ?n0 (pairT f32 f32)))")) }),
        rewrite!("vec-32-after-(f32, (f32, f32))"; "(typeOf ?e0 (arrT ?n0 (pairT f32 (pairT f32 f32))))" => { Shifted::new("?n0", "?n1", 1, 0, pat("(typeOf (app (typeOf asScalar (fun (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 (pairT f32 f32)))) (arrT ?n0 (pairT f32 (pairT f32 f32))))) (typeOf (app (typeOf (app (typeOf asVector (lam (fun (arrT (natMul %0 (natMul (natPow 32 -1) ?n1)) (pairT f32 (pairT f32 f32))) (arrT (natMul (natPow 32 -1) ?n1) (vecT %0 (pairT f32 (pairT f32 f32))))))) 32) (fun (arrT ?n0 (pairT f32 (pairT f32 f32))) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 (pairT f32 f32)))))) (typeOf ?e0 (arrT ?n0 (pairT f32 (pairT f32 f32))))) (arrT (natMul (natPow 32 -1) ?n0) (vecT 32 (pairT f32 (pairT f32 f32)))))) (arrT ?n0 (pairT f32 (pairT f32 f32))))")) }),
        rewrite!("vec-before-map-f32"; "(typeOf (app (typeOf (app (typeOf asVector ?) ?n0) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (fun f32 f32))) ?) (typeOf ?e1 (arrT ?n1 f32))) (arrT ?n2 f32))) (arrT ?n3 (vecT ?n0 f32)))" => { VectorizeScalaFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", 1, 0, ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (vecT ?n0 f32) (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (vecT ?n0 f32))))) (typeOf ?e2 (fun (vecT ?n0 f32) (vecT ?n0 f32)))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf (app (typeOf asVector (lam (fun (arrT (natMul %0 ?n4) f32) (arrT ?n4 (vecT %0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf ?e1 (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32)))"))))) }),
        rewrite!("vec-before-map-f32xf32"; "(typeOf (app (typeOf (app (typeOf asVector ?) ?n0) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (fun (pairT f32 f32) f32))) ?) (typeOf ?e1 (arrT ?n1 (pairT f32 f32)))) (arrT ?n2 f32))) (arrT ?n3 (vecT ?n0 f32)))" => { VectorizeScalaFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", 1, 0, ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (pairT (vecT ?n0 f32) (vecT ?n0 f32)) (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (vecT ?n0 f32))))) (typeOf ?e2 (fun (pairT (vecT ?n0 f32) (vecT ?n0 f32)) (vecT ?n0 f32)))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (typeOf (app (typeOf (app (typeOf asVector (lam (fun (arrT (natMul %0 ?n4) f32) (arrT ?n4 (vecT %0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf ?e1 (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (typeOf (app (typeOf (app (typeOf asVector (lam (fun (arrT (natMul %0 ?n4) f32) (arrT ?n4 (vecT %0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf ?e1 (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (arrT ?n3 (vecT ?n0 f32)))"))))) }),
        rewrite!("vec-before-map-f32x-f32xf32"; "(typeOf (app (typeOf (app (typeOf asVector ?) ?n0) ?) (typeOf (app (typeOf (app (typeOf map ?) (typeOf ?e0 (fun (pairT f32 (pairT f32 f32)) f32))) ?) (typeOf ?e1 (arrT ?n1 (pairT f32 (pairT f32 f32))))) (arrT ?n2 f32))) (arrT ?n3 (vecT ?n0 f32)))" => { VectorizeScalaFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", 1, 0, ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32))))) (typeOf ?e2 (fun (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (vecT ?n0 f32)))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))))))) (typeOf (app (typeOf (app (typeOf asVector (lam (fun (arrT (natMul %0 ?n4) f32) (arrT ?n4 (vecT %0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (typeOf ?e1 (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (typeOf (app (typeOf (app (typeOf asVector (lam (fun (arrT (natMul %0 ?n4) f32) (arrT ?n4 (vecT %0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (typeOf ?e1 (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (typeOf (app (typeOf (app (typeOf asVector (lam (fun (arrT (natMul %0 ?n4) f32) (arrT ?n4 (vecT %0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (typeOf ?e1 (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (arrT ?n3 (vecT ?n0 f32)))"))))) }),
        rewrite!("reduce-seq-unroll"; "(typeOf reduceSeq (fun (fun ?dt0 (fun ?dt1 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt1) ?dt0))))" => { pat("(typeOf reduceSeqUnroll (fun (fun ?dt0 (fun ?dt1 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt1) ?dt0))))") }),
        rewrite!("map-par"; "(typeOf map (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))))" => { pat("(typeOf mapPar (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))))") }),
    ];
    let reduce = [
        // reductions and abstraction
        rewrite!("beta"; "(app (lam ?body) ?e)" => { BetaExtractApplier::new("?body", "?e") }),
        rewrite!("eta"; "(lam (app ?f %0))" => { NotFreeIn::new("?f", 0, Shifted::new("?f", "?fd", -1, 0, pat("?fd"))) }),
    ];
    algorithmic.extend(reduce);
    algorithmic
}

struct BetaExtractApplier {
    body: Var,
    subs: Var,
}

impl BetaExtractApplier {
    fn new(body: &str, subs: &str) -> Self {
        Self {
            body: body.parse().unwrap(),
            subs: subs.parse().unwrap(),
        }
    }
}

impl Applier<Rise, RiseAnalysis> for BetaExtractApplier {
    fn apply_one(
        &self,
        egraph: &mut EGraph<Rise, RiseAnalysis>,
        eclass: Id,
        subst: &Subst,
        _searcher_ast: Option<&PatternAst<Rise>>,
        _rule_name: Symbol,
    ) -> Vec<Id> {
        let ex_body = &egraph[subst[self.body]].data.beta_extract;
        let ex_subs = &egraph[subst[self.subs]].data.beta_extract;
        let result = beta_reduce(ex_body, ex_subs);
        let id = egraph.add_expr(&result);
        egraph.union(eclass, id);
        vec![id]
    }
}

pub fn beta_reduce(body: &RecExpr<Rise>, arg: &RecExpr<Rise>) -> RecExpr<Rise> {
    let arg2 = &mut arg.as_ref().to_owned();

    shift_mut(arg2, 1, Index(0)); // shift up
    let mut body2 = replace(body.as_ref(), Index(0), arg2);
    shift_mut(&mut body2, -1, Index(0)); // shift down
    body2.into()
}

pub fn replace(expr: &[Rise], index: Index, subs: &mut [Rise]) -> Vec<Rise> {
    fn rec(
        result: &mut Vec<Rise>,
        expr: &[Rise],
        ei: usize,
        index: Index,
        subs: &mut [Rise],
    ) -> Id {
        match expr[ei] {
            Rise::Var(index2) => {
                if index == index2 {
                    add_expr(result, subs)
                } else {
                    add(result, Rise::Var(index2))
                }
            }
            Rise::Lambda(e) => {
                shift_mut(subs, 1, Index(0)); // shift up
                let e2 = rec(result, expr, usize::from(e), Index(index.0 + 1), subs);
                shift_mut(subs, -1, Index(0)); // shift down
                add(result, Rise::Lambda(e2))
            }
            Rise::App([f, e]) => {
                let f2 = rec(result, expr, usize::from(f), index, subs);
                let e2 = rec(result, expr, usize::from(e), index, subs);
                add(result, Rise::App([f2, e2]))
            }
            Rise::Symbol(_) => add(result, expr[ei].clone()),
            Rise::FunType(_)
            | Rise::TypeOf(_)
            | Rise::Integer(_)
            | Rise::ArrType(_)
            | Rise::VecType(_)
            | Rise::PairType(_)
            | Rise::IndexType(_)
            | Rise::NatType
            | Rise::F32
            | Rise::ToMem
            | Rise::Split
            | Rise::Join
            | Rise::NatAdd(_)
            | Rise::NatSub(_)
            | Rise::NatMul(_)
            | Rise::NatDiv(_)
            | Rise::NatPow(_)
            | Rise::AsVector
            | Rise::AsScalar
            | Rise::Snd
            | Rise::Fst
            | Rise::Generate
            | Rise::Transpose
            | Rise::Unzip
            | Rise::Zip
            | Rise::MapPar
            | Rise::Reduce
            | Rise::ReduceSeq
            | Rise::ReduceSeqUnroll => unimplemented!(),
        }
    }
    let mut result = vec![];
    rec(&mut result, expr, expr.len() - 1, index, subs);
    result
}

fn extract_small(
    egraph: &EGraph<Rise, RiseAnalysis>,
    pattern: &Pattern<Rise>,
    eclass_id: Id,
) -> Vec<RecExpr<Rise>> {
    let Some(matches) = pattern.search_eclass(egraph, eclass_id) else {
        return vec![];
    };

    let extractor = Extractor::new(egraph, AstSize);

    matches
        .substs
        .iter()
        .map(|subs| {
            let mut new_ast = Vec::new();
            let mut shift_starts: Vec<usize> = Vec::new();
            for pattern_node in &pattern.ast {
                match pattern_node {
                    ENodeOrVar::Var(w) => {
                        let subexpr = extractor.find_best(subs[*w]).1.to_vec();
                        let sub_len = subexpr.len();
                        let skip_len = shift_starts.last().unwrap();
                        new_ast.extend(subexpr.into_iter().map(|mut node| {
                            node.update_children(|i| Id::from(usize::from(i) + skip_len));
                            node
                        }));

                        shift_starts.extend(iter::repeat_n(skip_len + sub_len, sub_len));
                    }
                    ENodeOrVar::ENode(e) => {
                        let mut new_e = e.clone();
                        new_e.update_children(|i| {
                            let this_skip_len = shift_starts[usize::from(i)];
                            let new_i = Id::from(usize::from(i) + this_skip_len);
                            shift_starts.push(this_skip_len);
                            new_i
                        });
                        new_ast.push(new_e);
                    }
                }
            }
            RecExpr::from(new_ast)
        })
        .collect()
}

fn add(to: &mut Vec<Rise>, e: Rise) -> Id {
    to.push(e);
    Id::from(to.len() - 1)
}

fn add_expr(to: &mut Vec<Rise>, e: &[Rise]) -> Id {
    let offset = to.len();
    to.extend(e.iter().map(|n| {
        n.clone()
            .map_children(|id| Id::from(usize::from(id) + offset))
    }));
    Id::from(to.len() - 1)
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn beta_reduce_applier() {
        fn check(body: &str, arg: &str, res: &str) {
            let b = &body.parse().unwrap();
            let a = &arg.parse().unwrap();
            let r = res.parse().unwrap();
            assert_eq!(beta_reduce(b, a), r);
        }
        // (. (. ((. (0 1)) (0 1)))) --> (. (. ((0 1) 0)))
        // (. (0 1)) (0 1) --> (0 1) 0
        check("(app %0 %1)", "(app %0 %1)", "(app (app %0 %1) %0)");
        // r1 = (app (lam (app "%6" (app "%5" "%0"))) "%0")
        // r2 = (app (lam (app "%6" r1)) "%0")
        // r3 = (app (lam (app "%6" r2)) %0)
        // (app map (lam (app "%6" r3)))
        // --> (app map (lam (app "%6" (app "%5" (app "%4" (app "%3" (app "%2" "%0")))))))
        check("(app %6 (app %5 %0))", "%0", "(app %5 (app %4 %0))");
        check(
            "(app %6 (app %5 (app %4 %0)))",
            "%0",
            "(app %5 (app %4 (app %3 %0)))",
        );
        check(
            "(app %6 (app %5 (app %4 (app %3 %0))))",
            "%0",
            "(app %5 (app %4 (app %3 (app %2 %0))))",
        );
    }
}
