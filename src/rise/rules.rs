use egg::{MultiPattern, Pattern, Rewrite, rewrite};

use super::appliers::{
    BetaExtractApplier, ComputeNatCheck, NotFreeIn, Shifted, VectorizeScalarFun,
};
use super::kind::Kind;
use super::predicates::RisePredicate;
use super::{Rise, RiseAnalysis};

#[derive(Copy, Clone, Eq, PartialEq, Debug, Hash)]
pub enum Ruleset {
    All,
    Split,
    Reorder,
    Copy,
    Lowering,
}

#[must_use]
pub fn rules(ruleset: Ruleset) -> Vec<Rewrite<Rise, RiseAnalysis>> {
    let allowed_rules = match ruleset {
        Ruleset::All => vec![
            "map-fission",
            "reduce-seq",
            "eliminate-map-identity",
            "reduce-seq-map-fusion",
            "split-join-32",
            "split-join-2m-32",
            "blocked-reduce-4",
            "split-before-map",
            "reduce-seq-map-fission",
            "lift-reduce-seq",
            "lift-reduce-seq-2",
            "lift-reduce-seq-3",
            "transpose-around-map-map-f-1m",
            "store-to-mem",
            "map-array",
            "map-fusion",
            "map-eta-abstraction",
            "vec-32-after-f32",
            "vec-32-after-(f32, f32)",
            "vec-32-after-(f32, (f32, f32))",
            "vec-before-map-f32",
            "vec-before-map-f32xf32",
            "vec-before-map-f32x-f32xf32",
            "reduce-seq-unroll",
            "map-par",
        ],
        Ruleset::Split => vec![
            "map-fission",
            "reduce-seq",
            "eliminate-map-identity",
            "reduce-seq-map-fusion",
            "split-join-32",
            "split-join-2m-32",
            "blocked-reduce-4",
            "split-before-map",
        ],

        Ruleset::Reorder => vec![
            "map-fission",
            "eliminate-map-identity",
            "reduce-seq-map-fusion",
            "split-before-map",
            "reduce-seq-map-fission",
            "lift-reduce-seq",
            "lift-reduce-seq-2",
            "lift-reduce-seq-3",
            "transpose-around-map-map-f-1m",
        ],

        Ruleset::Copy => vec![
            "store-to-mem",
            "split-join-2m-32",
            "map-array",
            "transpose-around-map-map-f-1m",
        ],

        Ruleset::Lowering => vec![
            "map-fusion",
            "map-eta-abstraction",
            "vec-32-after-f32",
            "vec-32-after-(f32, f32)",
            "vec-32-after-(f32, (f32, f32))",
            "vec-before-map-f32",
            "vec-before-map-f32xf32",
            "vec-before-map-f32x-f32xf32",
            "reduce-seq-unroll",
            "map-par",
        ],
    };
    [
rewrite!("eta-reduction"; { RisePredicate::new(pat("(lam (app ?0 (%e0 ?t0) ?tAny0) (fun ?t0 ?t1))")) } => { NotFreeIn::new("?0", 0, Shifted::new("?0", "?1", (-1,0,0,0,0).into(), (1,0,0,0,0).into(), pat("?1"))) }),
rewrite!("map-fission"; { RisePredicate::new(pat("(app (map ?tAny2) (lam (app ?0 ?1 ?tAny3) (fun ?dt1 ?dt2)) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt2)))")) } => { NotFreeIn::new("?0", 0, Shifted::new("?1", "?2", (1,0,0,0,0).into(), (1,0,0,0,0).into(), pat("(lam (app (app (map (fun (fun ?dt0 ?dt2) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt2)))) ?0 (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt2))) (app (app (map (fun (fun ?dt1 ?dt0) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt0)))) (lam ?2 (fun ?dt1 ?dt0)) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt0))) (%e0 (arrT ?n0 ?dt1)) (arrT ?n0 ?dt0)) (arrT ?n0 ?dt2)) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt2)))"))) }),
rewrite!("reduce-seq"; { RisePredicate::new(pat("(reduce (fun (fun ?dt0 (fun ?dt0 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt0) ?dt0))))")) } => { pat("(reduceSeq (fun (fun ?dt0 (fun ?dt0 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt0) ?dt0))))") }),
rewrite!("eliminate-map-identity"; { RisePredicate::new(pat("(app (map ?tAny5) (lam (%e0 ?tAny6) (fun ?dt0 ?dt0)) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0)))")) } => { pat("(lam (%e0 (arrT ?n0 ?dt0)) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0)))") }),
rewrite!("reduce-seq-map-fusion"; { RisePredicate::new(pat("(app (app (app (reduceSeq ?tAny9) ?0 ?tAny8) ?1 ?tAny7) (app (app (map ?tAny11) ?2 ?tAny10) ?3 (arrT ?n0 ?dt1)) ?dt0)")) } => { Shifted::new("?2", "?5", (2,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?4", (2,0,0,0,0).into(), (0,0,0,0,0).into(), pat("(app (app (app (reduceSeq (fun (fun ?dt0 (fun ?dt2 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt2) ?dt0)))) (lam (lam (app (app ?4 (%e1 ?dt0) (fun ?dt1 ?dt0)) (app ?5 (%e0 ?dt2) ?dt1) ?dt0) (fun ?dt2 ?dt0)) (fun ?dt0 (fun ?dt2 ?dt0))) (fun ?dt0 (fun (arrT ?n0 ?dt2) ?dt0))) ?1 (fun (arrT ?n0 ?dt2) ?dt0)) ?3 ?dt0)"))) }),
rewrite!("split-join-32"; { RisePredicate::new(pat("(app (app (map ?tAny13) ?0 ?tAny12) ?1 (arrT ?n0 ?dt1))")) } => { Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), Shifted::new("?dt0", "?dt2", (1,0,0).into(), (0,0,0).into(), pat("(app (join (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)) (arrT ?n0 ?dt1))) (app (app (map (fun (fun (arrT 32n ?dt0) (arrT 32n ?dt1)) (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))))) (app (map (fun (fun ?dt0 ?dt1) (fun (arrT 32n ?dt0) (arrT 32n ?dt1)))) ?0 (fun (arrT 32n ?dt0) (arrT 32n ?dt1))) (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)))) (app (natApp (split (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n1)) ?dt2) (arrT (natMul (natPow 32n -1n) ?n1) (arrT %n0 ?dt2))))) 32n (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)))) ?1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0))) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))) (arrT ?n0 ?dt1))"))) }),
rewrite!("split-join-2m-32"; { RisePredicate::new(pat("(app (app (map ?tAny15) (app (map ?tAny16) (app (map ?tAny17) ?0 (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT ?n0 ?dt1)))) ?tAny14) ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))")) } => { Shifted::new("?n0", "?n3", (1,0).into(), (0,0).into(), Shifted::new("?dt0", "?dt2", (1,0,0).into(), (0,0,0).into(), pat("(app (app (map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1)))))) (app (map (fun (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)) (arrT ?n0 ?dt1)) (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))))) (join (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)) (arrT ?n0 ?dt1))) (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1)))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))) (app (app (map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))))))) (app (map (fun (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))) (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)))))) (app (map (fun (fun (arrT 32n ?dt0) (arrT 32n ?dt1)) (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))))) (app (map (fun (fun ?dt0 ?dt1) (fun (arrT 32n ?dt0) (arrT 32n ?dt1)))) ?0 (fun (arrT 32n ?dt0) (arrT 32n ?dt1))) (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)))) (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0))) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1)))))) (app (app (map (fun (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0))))))) (app (map (fun (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)))))) (natApp (split (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n3)) ?dt2) (arrT (natMul (natPow 32n -1n) ?n3) (arrT %n0 ?dt2))))) 32n (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0))))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0)))))) ?1 (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt0))))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?dt1))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))"))) }),
rewrite!("blocked-reduce-4"; { RisePredicate::new(pat("(app (app (app (reduce ?tAny20) ?0 ?tAny19) ?1 ?tAny18) ?2 ?dt0)")) } => { Shifted::new("?1", "?4", (2,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?3", (2,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), Shifted::new("?dt0", "?dt1", (1,0,0).into(), (0,0,0).into(), pat("(app (app (app (reduceSeq (fun (fun ?dt0 (fun (arrT 4n ?dt0) ?dt0)) (fun ?dt0 (fun (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?dt0)) ?dt0)))) (lam (lam (app (app ?3 (%e1 ?dt0) (fun ?dt0 ?dt0)) (app (app (app (reduce (fun (fun ?dt0 (fun ?dt0 ?dt0)) (fun ?dt0 (fun (arrT 4n ?dt0) ?dt0)))) ?3 (fun ?dt0 (fun (arrT 4n ?dt0) ?dt0))) ?4 (fun (arrT 4n ?dt0) ?dt0)) (%e0 (arrT 4n ?dt0)) ?dt0) ?dt0) (fun (arrT 4n ?dt0) ?dt0)) (fun ?dt0 (fun (arrT 4n ?dt0) ?dt0))) (fun ?dt0 (fun (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?dt0)) ?dt0))) ?1 (fun (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?dt0)) ?dt0)) (app (natApp (split (natFun (fun (arrT (natMul %n0 (natMul (natPow 4n -1n) ?n1)) ?dt1) (arrT (natMul (natPow 4n -1n) ?n1) (arrT %n0 ?dt1))))) 4n (fun (arrT ?n0 ?dt0) (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?dt0)))) ?2 (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?dt0))) ?dt0)"))))) }),
rewrite!("split-before-map"; { RisePredicate::new(pat("(app (natApp (split ?tAny22) ?n0 ?tAny21) (app (app (map ?tAny24) ?0 ?tAny23) ?1 (arrT ?n2 ?dt1)) (arrT ?n3 (arrT ?n0 ?dt1)))")) } => { Shifted::new("?n3", "?n4", (1,0).into(), (0,0).into(), Shifted::new("?dt0", "?dt2", (1,0,0).into(), (0,0,0).into(), ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(app (app (map (fun (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)) (fun (arrT ?n3 (arrT ?n0 ?dt0)) (arrT ?n3 (arrT ?n0 ?dt1))))) (app (map (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) ?0 (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))) (fun (arrT ?n3 (arrT ?n0 ?dt0)) (arrT ?n3 (arrT ?n0 ?dt1)))) (app (natApp (split (natFun (fun (arrT (natMul %n0 ?n4) ?dt2) (arrT ?n4 (arrT %n0 ?dt2))))) ?n0 (fun (arrT (natMul ?n3 ?n0) ?dt0) (arrT ?n3 (arrT ?n0 ?dt0)))) ?1 (arrT ?n3 (arrT ?n0 ?dt0))) (arrT ?n3 (arrT ?n0 ?dt1)))"))))) }),
rewrite!("reduce-seq-map-fission"; { RisePredicate::new(pat("(app (app (reduceSeq ?tAny26) (lam (lam (app (app ?0 (%e1 ?dt0) ?tAny29) ?1 ?tAny28) ?tAny27) (fun ?dt0 (fun ?dt2 ?dt0))) ?tAny25) ?2 (fun (arrT ?n0 ?dt2) ?dt0))")) } => { NotFreeIn::new("?0", 0, Shifted::new("?2", "?4", (1,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?3", (-1,0,0,0,0).into(), (2,0,0,0,0).into(), pat("(lam (app (app (app (reduceSeq (fun (fun ?dt0 (fun ?dt1 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt1) ?dt0)))) ?3 (fun ?dt0 (fun (arrT ?n0 ?dt1) ?dt0))) ?4 (fun (arrT ?n0 ?dt1) ?dt0)) (app (app (map (fun (fun ?dt2 ?dt1) (fun (arrT ?n0 ?dt2) (arrT ?n0 ?dt1)))) (lam ?1 (fun ?dt2 ?dt1)) (fun (arrT ?n0 ?dt2) (arrT ?n0 ?dt1))) (%e0 (arrT ?n0 ?dt2)) (arrT ?n0 ?dt1)) ?dt0) (fun (arrT ?n0 ?dt2) ?dt0))")))) }),
rewrite!("lift-reduce-seq"; { RisePredicate::new(pat("(app (map ?tAny31) (app (app (reduceSeq ?tAny33) ?0 ?tAny32) ?1 (fun (arrT ?n0 ?dt1) ?dt0)) (fun (arrT ?n1 (arrT ?n0 ?dt1)) (arrT ?n1 ?dt0)))")) } => { Shifted::new("?1", "?3", (2,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?2", (4,0,0,0,0).into(), (0,0,0,0,0).into(), pat("(lam (app (app (app (reduceSeq (fun (fun (arrT ?n1 ?dt0) (fun (arrT ?n1 ?dt1) (arrT ?n1 ?dt0))) (fun (arrT ?n1 ?dt0) (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 ?dt0))))) (lam (lam (app (app (map (fun (fun (pairT ?dt0 ?dt1) ?dt0) (fun (arrT ?n1 (pairT ?dt0 ?dt1)) (arrT ?n1 ?dt0)))) (lam (app (app ?2 (app (fst (fun (pairT ?dt0 ?dt1) ?dt0)) (%e0 (pairT ?dt0 ?dt1)) ?dt0) (fun ?dt1 ?dt0)) (app (snd (fun (pairT ?dt0 ?dt1) ?dt1)) (%e0 (pairT ?dt0 ?dt1)) ?dt1) ?dt0) (fun (pairT ?dt0 ?dt1) ?dt0)) (fun (arrT ?n1 (pairT ?dt0 ?dt1)) (arrT ?n1 ?dt0))) (app (app (zip (fun (arrT ?n1 ?dt0) (fun (arrT ?n1 ?dt1) (arrT ?n1 (pairT ?dt0 ?dt1))))) (%e1 (arrT ?n1 ?dt0)) (fun (arrT ?n1 ?dt1) (arrT ?n1 (pairT ?dt0 ?dt1)))) (%e0 (arrT ?n1 ?dt1)) (arrT ?n1 (pairT ?dt0 ?dt1))) (arrT ?n1 ?dt0)) (fun (arrT ?n1 ?dt1) (arrT ?n1 ?dt0))) (fun (arrT ?n1 ?dt0) (fun (arrT ?n1 ?dt1) (arrT ?n1 ?dt0)))) (fun (arrT ?n1 ?dt0) (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 ?dt0)))) (app (generate (fun (fun (idxT ?n1) ?dt0) (arrT ?n1 ?dt0))) (lam ?3 (fun (idxT ?n1) ?dt0)) (arrT ?n1 ?dt0)) (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 ?dt0))) (app (transpose (fun (arrT ?n1 (arrT ?n0 ?dt1)) (arrT ?n0 (arrT ?n1 ?dt1)))) (%e0 (arrT ?n1 (arrT ?n0 ?dt1))) (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n1 ?dt0)) (fun (arrT ?n1 (arrT ?n0 ?dt1)) (arrT ?n1 ?dt0)))"))) }),
rewrite!("lift-reduce-seq-2"; { RisePredicate::new(pat("(app (map ?tAny34) (lam (app (app (add ?tAny37) (app (fst ?tAny38) (%e0 (pairT f32 (arrT ?n0 ?dt0))) f32) ?tAny36) (app (app (app (reduceSeq ?tAny41) ?0 ?tAny40) (0.0 f32) ?tAny39) (app (snd ?tAny42) (%e0 (pairT f32 (arrT ?n0 ?dt0))) (arrT ?n0 ?dt0)) f32) ?tAny35) (fun (pairT f32 (arrT ?n0 ?dt0)) f32)) (fun (arrT ?n1 (pairT f32 (arrT ?n0 ?dt0))) (arrT ?n1 f32)))")) } => { Shifted::new("?0", "?1", (4,0,0,0,0).into(), (1,0,0,0,0).into(), pat("(lam (app (lam (app (app (app (reduceSeq (fun (fun (arrT ?n1 f32) (fun (arrT ?n1 ?dt0) (arrT ?n1 f32))) (fun (arrT ?n1 f32) (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n1 f32))))) (lam (lam (app (app (map (fun (fun (pairT f32 ?dt0) f32) (fun (arrT ?n1 (pairT f32 ?dt0)) (arrT ?n1 f32)))) (lam (app (app ?1 (app (fst (fun (pairT f32 ?dt0) f32)) (%e0 (pairT f32 ?dt0)) f32) (fun ?dt0 f32)) (app (snd (fun (pairT f32 ?dt0) ?dt0)) (%e0 (pairT f32 ?dt0)) ?dt0) f32) (fun (pairT f32 ?dt0) f32)) (fun (arrT ?n1 (pairT f32 ?dt0)) (arrT ?n1 f32))) (app (app (zip (fun (arrT ?n1 f32) (fun (arrT ?n1 ?dt0) (arrT ?n1 (pairT f32 ?dt0))))) (%e1 (arrT ?n1 f32)) (fun (arrT ?n1 ?dt0) (arrT ?n1 (pairT f32 ?dt0)))) (%e0 (arrT ?n1 ?dt0)) (arrT ?n1 (pairT f32 ?dt0))) (arrT ?n1 f32)) (fun (arrT ?n1 ?dt0) (arrT ?n1 f32))) (fun (arrT ?n1 f32) (fun (arrT ?n1 ?dt0) (arrT ?n1 f32)))) (fun (arrT ?n1 f32) (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n1 f32)))) (app (fst (fun (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n1 f32))) (%e0 (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?dt0)))) (arrT ?n1 f32)) (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n1 f32))) (app (transpose (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt0)))) (app (snd (fun (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n1 (arrT ?n0 ?dt0)))) (%e0 (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?dt0)))) (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n0 (arrT ?n1 ?dt0))) (arrT ?n1 f32)) (fun (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n1 f32))) (app (unzip (fun (arrT ?n1 (pairT f32 (arrT ?n0 ?dt0))) (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?dt0))))) (%e0 (arrT ?n1 (pairT f32 (arrT ?n0 ?dt0)))) (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?dt0)))) (arrT ?n1 f32)) (fun (arrT ?n1 (pairT f32 (arrT ?n0 ?dt0))) (arrT ?n1 f32)))")) }),
rewrite!("lift-reduce-seq-3"; { RisePredicate::new(pat("(app (map ?tAny43) (lam (app (app (app (reduceSeq ?tAny47) ?0 ?tAny46) (app (fst ?tAny48) (app (unzip ?tAny49) (%e0 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n0 ?dt0)) ?tAny45) (app (transpose ?tAny50) (app (snd ?tAny51) (app (unzip ?tAny52) (%e0 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n1 (arrT ?n0 ?dt1))) ?tAny44) (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (arrT ?n0 ?dt0))) (fun (arrT ?n2 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n2 (arrT ?n0 ?dt0))))")) } => { NotFreeIn::new("?0", 0, Shifted::new("?0", "?1", (3,0,0,0,0).into(), (1,0,0,0,0).into(), pat("(lam (app (app (app (reduceSeq (fun (fun (arrT ?n2 (arrT ?n0 ?dt0)) (fun (arrT ?n2 (arrT ?n0 ?dt1)) (arrT ?n2 (arrT ?n0 ?dt0)))) (fun (arrT ?n2 (arrT ?n0 ?dt0)) (fun (arrT ?n1 (arrT ?n2 (arrT ?n0 ?dt1))) (arrT ?n2 (arrT ?n0 ?dt0)))))) (lam (lam (app (app (map (fun (fun (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)) (arrT ?n0 ?dt0)) (fun (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))) (arrT ?n2 (arrT ?n0 ?dt0))))) (lam (app (app ?1 (app (fst (fun (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)) (arrT ?n0 ?dt0))) (%e0 (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))) (arrT ?n0 ?dt0)) (fun (arrT ?n0 ?dt1) (arrT ?n0 ?dt0))) (app (snd (fun (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)) (arrT ?n0 ?dt1))) (%e0 (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))) (arrT ?n0 ?dt1)) (arrT ?n0 ?dt0)) (fun (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)) (arrT ?n0 ?dt0))) (fun (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))) (arrT ?n2 (arrT ?n0 ?dt0)))) (app (app (zip (fun (arrT ?n2 (arrT ?n0 ?dt0)) (fun (arrT ?n2 (arrT ?n0 ?dt1)) (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))))) (%e1 (arrT ?n2 (arrT ?n0 ?dt0))) (fun (arrT ?n2 (arrT ?n0 ?dt1)) (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))))) (%e0 (arrT ?n2 (arrT ?n0 ?dt1))) (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) (arrT ?n2 (arrT ?n0 ?dt0))) (fun (arrT ?n2 (arrT ?n0 ?dt1)) (arrT ?n2 (arrT ?n0 ?dt0)))) (fun (arrT ?n2 (arrT ?n0 ?dt0)) (fun (arrT ?n2 (arrT ?n0 ?dt1)) (arrT ?n2 (arrT ?n0 ?dt0))))) (fun (arrT ?n2 (arrT ?n0 ?dt0)) (fun (arrT ?n1 (arrT ?n2 (arrT ?n0 ?dt1))) (arrT ?n2 (arrT ?n0 ?dt0))))) (app (fst (fun (pairT (arrT ?n2 (arrT ?n0 ?dt0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n2 (arrT ?n0 ?dt0)))) (app (unzip (fun (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (pairT (arrT ?n2 (arrT ?n0 ?dt0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1)))))) (app (app (map (fun (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (fun (arrT ?n2 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))))) (unzip (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))) (fun (arrT ?n2 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (%e0 (arrT ?n2 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))))) (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))) (pairT (arrT ?n2 (arrT ?n0 ?dt0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n2 (arrT ?n0 ?dt0))) (fun (arrT ?n1 (arrT ?n2 (arrT ?n0 ?dt1))) (arrT ?n2 (arrT ?n0 ?dt0)))) (app (transpose (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))) (arrT ?n1 (arrT ?n2 (arrT ?n0 ?dt1))))) (app (app (map (fun (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1)))))) (transpose (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1)))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))) (app (snd (fun (pairT (arrT ?n2 (arrT ?n0 ?dt0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))))) (app (unzip (fun (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (pairT (arrT ?n2 (arrT ?n0 ?dt0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1)))))) (app (app (map (fun (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))) (fun (arrT ?n2 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))))) (unzip (fun (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))) (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))) (fun (arrT ?n2 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1)))))) (%e0 (arrT ?n2 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1))))) (arrT ?n2 (pairT (arrT ?n0 ?dt0) (arrT ?n0 (arrT ?n1 ?dt1))))) (pairT (arrT ?n2 (arrT ?n0 ?dt0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1)))) (arrT ?n1 (arrT ?n2 (arrT ?n0 ?dt1)))) (arrT ?n2 (arrT ?n0 ?dt0))) (fun (arrT ?n2 (arrT ?n0 (pairT ?dt0 (arrT ?n1 ?dt1)))) (arrT ?n2 (arrT ?n0 ?dt0))))"))) }),
rewrite!("transpose-around-map-map-f-1m"; { RisePredicate::new(pat("(app (app (map ?tAny54) (app (map ?tAny55) (app (map ?tAny56) ?0 (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))) (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n1 (arrT ?n0 ?dt1)))) ?tAny53) ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))")) } => { pat("(app (app (map (fun (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1)))))) (transpose (fun (arrT ?n0 (arrT ?n1 ?dt1)) (arrT ?n1 (arrT ?n0 ?dt1)))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))) (app (app (map (fun (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1)))))) (app (map (fun (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt1)) (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt1))))) (app (map (fun (fun ?dt0 ?dt1) (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt1)))) ?0 (fun (arrT ?n1 ?dt0) (arrT ?n1 ?dt1))) (fun (arrT ?n0 (arrT ?n1 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt1)))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1))))) (app (app (map (fun (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt0))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0)))))) (transpose (fun (arrT ?n1 (arrT ?n0 ?dt0)) (arrT ?n0 (arrT ?n1 ?dt0)))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0))))) ?1 (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt0)))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?dt1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?dt1))))") }),
rewrite!("store-to-mem"; { RisePredicate::new(pat("?0")) } => { pat("(app (app (let (fun ?dt0 (fun (fun ?dt0 ?dt0) ?dt0))) (app (toMem (fun ?dt0 ?dt0)) ?0 ?dt0) (fun (fun ?dt0 ?dt0) ?dt0)) (lam (%e0 ?dt0) (fun ?dt0 ?dt0)) ?dt0)") }),
rewrite!("map-array"; { RisePredicate::new(pat("?0")) } => { pat("(app (app (map (fun (fun ?dt0 ?dt0) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0)))) (lam (%e0 ?dt0) (fun ?dt0 ?dt0)) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt0))) ?0 (arrT ?n0 ?dt0))") }),
rewrite!("map-fusion"; { RisePredicate::new(pat("(app (app (map ?tAny58) ?0 ?tAny57) (app (app (map ?tAny60) ?1 ?tAny59) ?2 (arrT ?n0 ?dt0)) (arrT ?n0 ?dt1))")) } => { Shifted::new("?1", "?4", (1,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?3", (1,0,0,0,0).into(), (0,0,0,0,0).into(), pat("(app (app (map (fun (fun ?dt2 ?dt1) (fun (arrT ?n0 ?dt2) (arrT ?n0 ?dt1)))) (lam (app ?3 (app ?4 (%e0 ?dt2) ?dt0) ?dt1) (fun ?dt2 ?dt1)) (fun (arrT ?n0 ?dt2) (arrT ?n0 ?dt1))) ?2 (arrT ?n0 ?dt1))"))) }),
rewrite!("map-eta-abstraction"; { RisePredicate::new(pat("(app (map ?tAny61) ?0 (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))")) } => { Shifted::new("?0", "?1", (1,0,0,0,0).into(), (0,0,0,0,0).into(), pat("(lam (app (app (map (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))) ?1 (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))) (%e0 (arrT ?n0 ?dt0)) (arrT ?n0 ?dt1)) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1)))")) }),
rewrite!("vec-32-after-f32"; { RisePredicate::new(pat("?0")) } => { Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), pat("(app (asScalar (fun (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n f32)) (arrT ?n0 f32))) (app (natApp (asVector (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n1)) f32) (arrT (natMul (natPow 32n -1n) ?n1) (vecT %n0 f32))))) 32n (fun (arrT ?n0 f32) (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n f32)))) ?0 (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n f32))) (arrT ?n0 f32))")) }),
rewrite!("vec-32-after-(f32, f32)"; { RisePredicate::new(pat("?0")) } => { Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), pat("(app (asScalar (fun (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 f32))) (arrT ?n0 (pairT f32 f32)))) (app (natApp (asVector (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n1)) (pairT f32 f32)) (arrT (natMul (natPow 32n -1n) ?n1) (vecT %n0 (pairT f32 f32)))))) 32n (fun (arrT ?n0 (pairT f32 f32)) (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 f32))))) ?0 (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 f32)))) (arrT ?n0 (pairT f32 f32)))")) }),
rewrite!("vec-32-after-(f32, (f32, f32))"; { RisePredicate::new(pat("?0")) } => { Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), pat("(app (asScalar (fun (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 (pairT f32 f32)))) (arrT ?n0 (pairT f32 (pairT f32 f32))))) (app (natApp (asVector (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n1)) (pairT f32 (pairT f32 f32))) (arrT (natMul (natPow 32n -1n) ?n1) (vecT %n0 (pairT f32 (pairT f32 f32))))))) 32n (fun (arrT ?n0 (pairT f32 (pairT f32 f32))) (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 (pairT f32 f32)))))) ?0 (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 (pairT f32 f32))))) (arrT ?n0 (pairT f32 (pairT f32 f32))))")) }),
rewrite!("vec-before-map-f32"; { RisePredicate::new(pat("(app (natApp (asVector ?tAny63) ?n0 ?tAny62) (app (app (map ?tAny65) ?0 ?tAny64) ?1 (arrT ?n2 f32)) (arrT ?n3 (vecT ?n0 f32)))")) } => { VectorizeScalarFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", (1,0).into(), (0,0).into(), ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(app (app (map (fun (fun (vecT ?n0 f32) (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (vecT ?n0 f32))))) ?2 (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (vecT ?n0 f32)))) (app (natApp (asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0 (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) ?1 (arrT ?n3 (vecT ?n0 f32))) (arrT ?n3 (vecT ?n0 f32)))"))))) }),
rewrite!("vec-before-map-f32xf32"; { RisePredicate::new(pat("(app (natApp (asVector ?tAny67) ?n0 ?tAny66) (app (app (map ?tAny69) ?0 ?tAny68) ?1 (arrT ?n2 f32)) (arrT ?n3 (vecT ?n0 f32)))")) } => { VectorizeScalarFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", (1,0).into(), (0,0).into(), ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(app (app (map (fun (fun (pairT (vecT ?n0 f32) (vecT ?n0 f32)) (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (vecT ?n0 f32))))) ?2 (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (vecT ?n0 f32)))) (app (app (zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (app (natApp (asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0 (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (app (fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (app (unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) ?1 (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32))) (arrT (natMul ?n3 ?n0) f32)) (arrT ?n3 (vecT ?n0 f32))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (app (natApp (asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0 (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (app (snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (app (unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) ?1 (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32))) (arrT (natMul ?n3 ?n0) f32)) (arrT ?n3 (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32)))"))))) }),
rewrite!("vec-before-map-f32x-f32xf32"; { RisePredicate::new(pat("(app (natApp (asVector ?tAny71) ?n0 ?tAny70) (app (app (map ?tAny73) ?0 ?tAny72) ?1 (arrT ?n2 f32)) (arrT ?n3 (vecT ?n0 f32)))")) } => { VectorizeScalarFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", (1,0).into(), (0,0).into(), ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(app (app (map (fun (fun (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32))))) ?2 (fun (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32)))) (app (app (zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))))))) (app (natApp (asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0 (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (app (fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) f32))) (app (unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) ?1 (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (arrT (natMul ?n3 ?n0) f32)) (arrT ?n3 (vecT ?n0 f32))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (app (app (zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (app (natApp (asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0 (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (app (fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (app (unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (app (snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (app (unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) ?1 (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32))) (arrT (natMul ?n3 ?n0) f32)) (arrT ?n3 (vecT ?n0 f32))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (app (natApp (asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0 (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (app (snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (app (unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (app (snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (app (unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) ?1 (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32))) (arrT (natMul ?n3 ?n0) f32)) (arrT ?n3 (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (arrT ?n3 (vecT ?n0 f32)))"))))) }),
rewrite!("reduce-seq-unroll"; { RisePredicate::new(pat("(reduceSeq (fun (fun ?dt0 (fun ?dt1 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt1) ?dt0))))")) } => { pat("(reduceSeqUnroll (fun (fun ?dt0 (fun ?dt1 ?dt0)) (fun ?dt0 (fun (arrT ?n0 ?dt1) ?dt0))))") }),
rewrite!("map-par"; { RisePredicate::new(pat("(map (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))))")) } => { pat("(mapPar (fun (fun ?dt0 ?dt1) (fun (arrT ?n0 ?dt0) (arrT ?n0 ?dt1))))") }),

].into_iter().filter(|r|allowed_rules.contains(&r.name.as_str())).chain([
            rewrite!("eta-reduction"; { RisePredicate::new(pat("(typeOf (lam (typeOf (app (typeOf ?0 ?tAny0) (typeOf %e0 ?t0)) ?tAny1)) (fun ?t0 ?t1))")) } => { NotFreeIn::new("?0", 0, Shifted::new("?0", "?1", (-1,0,0,0,0).into(), (1,0,0,0,0).into(), pat("(typeOf ?1 (fun ?t0 ?t1))"))) }),
            // // OLD: rewrite!("beta"; { RisePredicate::new(pat("(app (lam ?body) ?e)")) } => { BetaExtractApplier::new("?body", "?e") }),
            rewrite!("beta"; { RisePredicate::new(pat("(app (typeOf (lam (typeOf ?body ?bodyTy)) ?lamTy) (typeOf ?subs ?subsTy))")) } => { BetaExtractApplier::new("?body", "?subs", Kind::Expr) }),
            // // Nat expr, type expr and addr expr have no type!
            // rewrite!("beta-nat"; { RisePredicate::new(pat("(natApp (typeOf (natLam (typeOf ?body ?bodyTy)) ?lamTy) ?subs)")) } => { BetaExtractApplier::new("?body", "?subs",Kind::Nat) }),
            // rewrite!("beta-data"; { RisePredicate::new(pat("(dataApp (typeOf (dataLam (typeOf ?body ?bodyTy)) ?lamTy) ?subs)")) } => { BetaExtractApplier::new("?body", "?subs",Kind::Data) }),
            // rewrite!("beta-addr"; { RisePredicate::new(pat("(addrApp (typeOf (addrLam (typeOf ?body ?bodyTy)) ?lamTy) ?subs)")) } => { BetaExtractApplier::new("?body", "?subs",Kind::Addr) }),
            //  // rewrite!("beta-nat-nat"; { RisePredicate::new(pat("(natNatApp (typeOf (natNatLam (typeOf ?body ?bodyTy)) ?lamTy) (typeOf ?subs ?subsTy))")) } => { BetaExtractApplier::new("?body", "?subs") }),
     ]).collect()
}

pub fn pat(pat: &str) -> Pattern<Rise> {
    pat.parse::<Pattern<Rise>>().unwrap()
}
