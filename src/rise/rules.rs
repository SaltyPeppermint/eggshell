use egg::{Pattern, Rewrite, rewrite};

use super::appliers::{
    BetaExtractApplier, ComputeNatCheck, DTCheck, NotFreeIn, Shifted, VectorizeScalarFun,
};
use super::kind::Kind;
use super::predicates::RisePredicate;
use super::{Rise, RiseAnalysis};

#[derive(Copy, Clone, Eq, PartialEq, Debug, Hash)]
pub enum Ruleset {
    All,
    Split,
    Reorder,
    Copy,
    Lowering,
}
#[must_use]
pub fn rules(ruleset: Ruleset) -> Vec<Rewrite<Rise, RiseAnalysis>> {
    let allowed_rules = match ruleset {
        Ruleset::All => vec![
            "eta-reduction",
            "map-fission",
            "reduce-seq",
            "eliminate-map-identity",
            "reduce-seq-map-fusion",
            "split-join-32",
            "split-join-2m-32",
            "blocked-reduce-4",
            "split-before-map",
            "reduce-seq-map-fission",
            "lift-reduce-seq",
            "lift-reduce-seq-2",
            "lift-reduce-seq-3",
            "transpose-around-map-map-f-1m",
            "store-to-mem",
            "map-array",
            "map-fusion",
            "map-eta-abstraction",
            "vec-32-after-f32",
            "vec-32-after-(f32, f32)",
            "vec-32-after-(f32, (f32, f32))",
            "vec-before-map-f32",
            "vec-before-map-f32xf32",
            "vec-before-map-f32x-f32xf32",
            "reduce-seq-unroll",
            "map-par",
        ],
        Ruleset::Split => vec![
            "map-fission",
            "reduce-seq",
            "eliminate-map-identity",
            "reduce-seq-map-fusion",
            "split-join-32",
            "split-join-2m-32",
            "blocked-reduce-4",
            "split-before-map",
        ],

        Ruleset::Reorder => vec![
            "map-fission",
            "reduce-seq-map-fusion",
            "reduce-seq-map-fission",
            "eliminate-map-identity",
            "split-before-map",
            "lift-reduce-seq",
            "lift-reduce-seq-2",
            "lift-reduce-seq-3",
            "transpose-around-map-map-f-1m",
        ],

        Ruleset::Copy => vec![
            "store-to-mem",
            "split-join-2-32",
            "map-array",
            "transpose-around-map-map-f-1m",
        ],

        Ruleset::Lowering => vec![
            "map-fusion",
            "map-eta-abstraction",
            "vec-32-after-f32",
            "vec-32-after-(f32, f32)",
            "vec-32-after-(f32, (f32, f32))",
            "vec-before-map-f32",
            "vec-before-map-f32xf32",
            "vec-before-map-f32x-f32xf32",
            "reduce-seq-unroll",
            "map-par",
        ],
    };
    [
rewrite!("eta-reduction"; { RisePredicate::new(pat("(typeOf (lam (typeOf (app (typeOf ?0 ?tAny0) (typeOf %e0 ?t0)) ?tAny1)) (fun ?t0 ?t1))")) } => { DTCheck::new(NotFreeIn::new("?0", 0, Shifted::new("?0", "?1", (-1,0,0,0,0).into(), (1,0,0,0,0).into(), pat("(typeOf ?1 (fun ?t0 ?t1))")))) }),
rewrite!("map-fission"; { RisePredicate::new(pat("(typeOf (app (typeOf map ?tAny2) (typeOf (lam (typeOf (app (typeOf ?0 ?tAny3) (typeOf ?1 ?d0)) ?tAny4)) (fun ?d1 ?d2))) (fun (arrT ?n0 ?d1) (arrT ?n0 ?d2)))")) } => { DTCheck::new(NotFreeIn::new("?0", 0, Shifted::new("?1", "?2", (1,0,0,0,0).into(), (1,0,0,0,0).into(), pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun ?d0 ?d2) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d2)))) (typeOf ?0 (fun ?d0 ?d2))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d2))) (typeOf (app (typeOf (app (typeOf map (fun (fun ?d1 ?d0) (fun (arrT ?n0 ?d1) (arrT ?n0 ?d0)))) (typeOf (lam (typeOf ?2 ?d0)) (fun ?d1 ?d0))) (fun (arrT ?n0 ?d1) (arrT ?n0 ?d0))) (typeOf %e0 (arrT ?n0 ?d1))) (arrT ?n0 ?d0))) (arrT ?n0 ?d2))) (fun (arrT ?n0 ?d1) (arrT ?n0 ?d2)))")))) }),
rewrite!("reduce-seq"; { RisePredicate::new(pat("(typeOf reduce (fun (fun ?d0 (fun ?d0 ?d0)) (fun ?d0 (fun (arrT ?n0 ?d0) ?d0))))")) } => { DTCheck::new(pat("(typeOf reduceSeq (fun (fun ?d0 (fun ?d0 ?d0)) (fun ?d0 (fun (arrT ?n0 ?d0) ?d0))))")) }),
rewrite!("eliminate-map-identity"; { RisePredicate::new(pat("(typeOf (app (typeOf map ?tAny5) (typeOf (lam (typeOf %e0 ?tAny6)) (fun ?d0 ?d0))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d0)))")) } => { DTCheck::new(pat("(typeOf (lam (typeOf %e0 (arrT ?n0 ?d0))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d0)))")) }),
rewrite!("reduce-seq-map-fusion"; { RisePredicate::new(pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?tAny7) (typeOf ?0 (fun ?d0 (fun ?d1 ?d0)))) ?tAny8) (typeOf ?1 ?d0)) ?tAny9) (typeOf (app (typeOf (app (typeOf map ?tAny10) (typeOf ?2 (fun ?d2 ?d1))) ?tAny11) (typeOf ?3 (arrT ?n0 ?d2))) (arrT ?n0 ?d1))) ?d0)")) } => { DTCheck::new(Shifted::new("?2", "?5", (2,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?4", (2,0,0,0,0).into(), (0,0,0,0,0).into(), pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun ?d0 (fun ?d2 ?d0)) (fun ?d0 (fun (arrT ?n0 ?d2) ?d0)))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?4 (fun ?d0 (fun ?d1 ?d0))) (typeOf %e1 ?d0)) (fun ?d1 ?d0)) (typeOf (app (typeOf ?5 (fun ?d2 ?d1)) (typeOf %e0 ?d2)) ?d1)) ?d0)) (fun ?d2 ?d0))) (fun ?d0 (fun ?d2 ?d0)))) (fun ?d0 (fun (arrT ?n0 ?d2) ?d0))) (typeOf ?1 ?d0)) (fun (arrT ?n0 ?d2) ?d0)) (typeOf ?3 (arrT ?n0 ?d2))) ?d0)")))) }),
rewrite!("split-join-32"; { RisePredicate::new(pat("(typeOf (app (typeOf (app (typeOf map ?tAny12) (typeOf ?0 (fun ?d0 ?d1))) ?tAny13) (typeOf ?1 (arrT ?n0 ?d0))) (arrT ?n0 ?d1))")) } => { DTCheck::new(Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), Shifted::new("?d0", "?d2", (1,0,0).into(), (0,0,0).into(), pat("(typeOf (app (typeOf join (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)) (arrT ?n0 ?d1))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT 32n ?d0) (arrT 32n ?d1)) (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1))))) (typeOf (app (typeOf map (fun (fun ?d0 ?d1) (fun (arrT 32n ?d0) (arrT 32n ?d1)))) (typeOf ?0 (fun ?d0 ?d1))) (fun (arrT 32n ?d0) (arrT 32n ?d1)))) (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)))) (typeOf (app (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n1)) ?d2) (arrT (natMul (natPow 32n -1n) ?n1) (arrT %n0 ?d2))))) 32n) (fun (arrT ?n0 ?d0) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)))) (typeOf ?1 (arrT ?n0 ?d0))) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)))) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)))) (arrT ?n0 ?d1))")))) }),
rewrite!("split-join-2m-32"; { RisePredicate::new(pat("(typeOf (app (typeOf (app (typeOf map ?tAny14) (typeOf (app (typeOf map ?tAny15) (typeOf (app (typeOf map ?tAny16) (typeOf ?0 (fun ?d0 ?d1))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1)))) (fun (arrT ?n1 (arrT ?n0 ?d0)) (arrT ?n1 (arrT ?n0 ?d1))))) ?tAny17) (typeOf ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d0))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1))))")) } => { DTCheck::new(Shifted::new("?n0", "?n3", (1,0).into(), (0,0).into(), Shifted::new("?d0", "?d2", (1,0,0).into(), (0,0,0).into(), pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1))) (arrT ?n1 (arrT ?n0 ?d1))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1)))))) (typeOf (app (typeOf map (fun (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)) (arrT ?n0 ?d1)) (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1))) (arrT ?n1 (arrT ?n0 ?d1))))) (typeOf join (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)) (arrT ?n0 ?d1)))) (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1))) (arrT ?n1 (arrT ?n0 ?d1))))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0))) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1))))))) (typeOf (app (typeOf map (fun (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1))) (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0))) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)))))) (typeOf (app (typeOf map (fun (fun (arrT 32n ?d0) (arrT 32n ?d1)) (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1))))) (typeOf (app (typeOf map (fun (fun ?d0 ?d1) (fun (arrT 32n ?d0) (arrT 32n ?d1)))) (typeOf ?0 (fun ?d0 ?d1))) (fun (arrT 32n ?d0) (arrT 32n ?d1)))) (fun (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1))))) (fun (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0))) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)))))) (fun (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT ?n0 ?d0)) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0))))))) (typeOf (app (typeOf map (fun (fun (arrT ?n0 ?d0) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0))) (fun (arrT ?n1 (arrT ?n0 ?d0)) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)))))) (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n3)) ?d2) (arrT (natMul (natPow 32n -1n) ?n3) (arrT %n0 ?d2))))) 32n) (fun (arrT ?n0 ?d0) (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0))))) (fun (arrT ?n1 (arrT ?n0 ?d0)) (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)))))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d0))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)))))) (typeOf ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d0))))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d0)))))) (arrT ?n2 (arrT ?n1 (arrT (natMul (natPow 32n -1n) ?n0) (arrT 32n ?d1)))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1))))")))) }),
rewrite!("blocked-reduce-4"; { RisePredicate::new(pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduce ?tAny18) (typeOf ?0 (fun ?d0 (fun ?d0 ?d0)))) ?tAny19) (typeOf ?1 ?d0)) ?tAny20) (typeOf ?2 (arrT ?n0 ?d0))) ?d0)")) } => { DTCheck::new(Shifted::new("?1", "?4", (2,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?3", (2,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), Shifted::new("?d0", "?d1", (1,0,0).into(), (0,0,0).into(), pat("(typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun ?d0 (fun (arrT 4n ?d0) ?d0)) (fun ?d0 (fun (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?d0)) ?d0)))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?3 (fun ?d0 (fun ?d0 ?d0))) (typeOf %e1 ?d0)) (fun ?d0 ?d0)) (typeOf (app (typeOf (app (typeOf (app (typeOf reduce (fun (fun ?d0 (fun ?d0 ?d0)) (fun ?d0 (fun (arrT 4n ?d0) ?d0)))) (typeOf ?3 (fun ?d0 (fun ?d0 ?d0)))) (fun ?d0 (fun (arrT 4n ?d0) ?d0))) (typeOf ?4 ?d0)) (fun (arrT 4n ?d0) ?d0)) (typeOf %e0 (arrT 4n ?d0))) ?d0)) ?d0)) (fun (arrT 4n ?d0) ?d0))) (fun ?d0 (fun (arrT 4n ?d0) ?d0)))) (fun ?d0 (fun (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?d0)) ?d0))) (typeOf ?1 ?d0)) (fun (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?d0)) ?d0)) (typeOf (app (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 (natMul (natPow 4n -1n) ?n1)) ?d1) (arrT (natMul (natPow 4n -1n) ?n1) (arrT %n0 ?d1))))) 4n) (fun (arrT ?n0 ?d0) (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?d0)))) (typeOf ?2 (arrT ?n0 ?d0))) (arrT (natMul (natPow 4n -1n) ?n0) (arrT 4n ?d0)))) ?d0)")))))) }),
rewrite!("split-before-map"; { RisePredicate::new(pat("(typeOf (app (typeOf (natApp (typeOf split ?tAny21) ?n0) ?tAny22) (typeOf (app (typeOf (app (typeOf map ?tAny23) (typeOf ?0 (fun ?d0 ?d1))) ?tAny24) (typeOf ?1 (arrT ?n1 ?d0))) (arrT ?n2 ?d1))) (arrT ?n3 (arrT ?n0 ?d1)))")) } => { DTCheck::new(Shifted::new("?n3", "?n4", (1,0).into(), (0,0).into(), Shifted::new("?d0", "?d2", (1,0,0).into(), (0,0,0).into(), ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1)) (fun (arrT ?n3 (arrT ?n0 ?d0)) (arrT ?n3 (arrT ?n0 ?d1))))) (typeOf (app (typeOf map (fun (fun ?d0 ?d1) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1)))) (typeOf ?0 (fun ?d0 ?d1))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1)))) (fun (arrT ?n3 (arrT ?n0 ?d0)) (arrT ?n3 (arrT ?n0 ?d1)))) (typeOf (app (typeOf (natApp (typeOf split (natFun (fun (arrT (natMul %n0 ?n4) ?d2) (arrT ?n4 (arrT %n0 ?d2))))) ?n0) (fun (arrT (natMul ?n3 ?n0) ?d0) (arrT ?n3 (arrT ?n0 ?d0)))) (typeOf ?1 (arrT (natMul ?n3 ?n0) ?d0))) (arrT ?n3 (arrT ?n0 ?d0)))) (arrT ?n3 (arrT ?n0 ?d1)))")))))) }),
rewrite!("reduce-seq-map-fission"; { RisePredicate::new(pat("(typeOf (app (typeOf (app (typeOf reduceSeq ?tAny25) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf ?0 ?tAny26) (typeOf %e1 ?d0)) ?tAny27) (typeOf ?1 ?d1)) ?tAny28)) ?tAny29)) (fun ?d0 (fun ?d2 ?d0)))) ?tAny30) (typeOf ?2 ?d0)) (fun (arrT ?n0 ?d2) ?d0))")) } => { DTCheck::new(NotFreeIn::new("?0", 0, Shifted::new("?2", "?4", (1,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?3", (-1,0,0,0,0).into(), (2,0,0,0,0).into(), pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun ?d0 (fun ?d1 ?d0)) (fun ?d0 (fun (arrT ?n0 ?d1) ?d0)))) (typeOf ?3 (fun ?d0 (fun ?d1 ?d0)))) (fun ?d0 (fun (arrT ?n0 ?d1) ?d0))) (typeOf ?4 ?d0)) (fun (arrT ?n0 ?d1) ?d0)) (typeOf (app (typeOf (app (typeOf map (fun (fun ?d2 ?d1) (fun (arrT ?n0 ?d2) (arrT ?n0 ?d1)))) (typeOf (lam (typeOf ?1 ?d1)) (fun ?d2 ?d1))) (fun (arrT ?n0 ?d2) (arrT ?n0 ?d1))) (typeOf %e0 (arrT ?n0 ?d2))) (arrT ?n0 ?d1))) ?d0)) (fun (arrT ?n0 ?d2) ?d0))"))))) }),
rewrite!("lift-reduce-seq"; { RisePredicate::new(pat("(typeOf (app (typeOf map ?tAny31) (typeOf (app (typeOf (app (typeOf reduceSeq ?tAny32) (typeOf ?0 (fun ?d0 (fun ?d1 ?d0)))) ?tAny33) (typeOf ?1 ?d0)) (fun (arrT ?n0 ?d1) ?d0))) (fun (arrT ?n1 (arrT ?n0 ?d1)) (arrT ?n1 ?d0)))")) } => { DTCheck::new(Shifted::new("?1", "?3", (2,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?2", (4,0,0,0,0).into(), (0,0,0,0,0).into(), pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun (arrT ?n1 ?d0) (fun (arrT ?n1 ?d1) (arrT ?n1 ?d0))) (fun (arrT ?n1 ?d0) (fun (arrT ?n0 (arrT ?n1 ?d1)) (arrT ?n1 ?d0))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun (pairT ?d0 ?d1) ?d0) (fun (arrT ?n1 (pairT ?d0 ?d1)) (arrT ?n1 ?d0)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?2 (fun ?d0 (fun ?d1 ?d0))) (typeOf (app (typeOf fst (fun (pairT ?d0 ?d1) ?d0)) (typeOf %e0 (pairT ?d0 ?d1))) ?d0)) (fun ?d1 ?d0)) (typeOf (app (typeOf snd (fun (pairT ?d0 ?d1) ?d1)) (typeOf %e0 (pairT ?d0 ?d1))) ?d1)) ?d0)) (fun (pairT ?d0 ?d1) ?d0))) (fun (arrT ?n1 (pairT ?d0 ?d1)) (arrT ?n1 ?d0))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n1 ?d0) (fun (arrT ?n1 ?d1) (arrT ?n1 (pairT ?d0 ?d1))))) (typeOf %e1 (arrT ?n1 ?d0))) (fun (arrT ?n1 ?d1) (arrT ?n1 (pairT ?d0 ?d1)))) (typeOf %e0 (arrT ?n1 ?d1))) (arrT ?n1 (pairT ?d0 ?d1)))) (arrT ?n1 ?d0))) (fun (arrT ?n1 ?d1) (arrT ?n1 ?d0)))) (fun (arrT ?n1 ?d0) (fun (arrT ?n1 ?d1) (arrT ?n1 ?d0))))) (fun (arrT ?n1 ?d0) (fun (arrT ?n0 (arrT ?n1 ?d1)) (arrT ?n1 ?d0)))) (typeOf (app (typeOf generate (fun (fun (idxT ?n1) ?d0) (arrT ?n1 ?d0))) (typeOf (lam (typeOf ?3 ?d0)) (fun (idxT ?n1) ?d0))) (arrT ?n1 ?d0))) (fun (arrT ?n0 (arrT ?n1 ?d1)) (arrT ?n1 ?d0))) (typeOf (app (typeOf transpose (fun (arrT ?n1 (arrT ?n0 ?d1)) (arrT ?n0 (arrT ?n1 ?d1)))) (typeOf %e0 (arrT ?n1 (arrT ?n0 ?d1)))) (arrT ?n0 (arrT ?n1 ?d1)))) (arrT ?n1 ?d0))) (fun (arrT ?n1 (arrT ?n0 ?d1)) (arrT ?n1 ?d0)))")))) }),
rewrite!("lift-reduce-seq-2"; { RisePredicate::new(pat("(typeOf (app (typeOf map ?tAny34) (typeOf (lam (typeOf (app (typeOf (app (typeOf add ?tAny35) (typeOf (app (typeOf fst ?tAny36) (typeOf %e0 (pairT f32 (arrT ?n0 ?d0)))) f32)) ?tAny37) (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?tAny38) (typeOf ?0 (fun f32 (fun ?d0 f32)))) ?tAny39) (typeOf 0.0 f32)) ?tAny40) (typeOf (app (typeOf snd ?tAny41) (typeOf %e0 (pairT f32 (arrT ?n0 ?d0)))) (arrT ?n0 ?d0))) f32)) ?tAny42)) (fun (pairT f32 (arrT ?n0 ?d0)) f32))) (fun (arrT ?n1 (pairT f32 (arrT ?n0 ?d0))) (arrT ?n1 f32)))")) } => { DTCheck::new(Shifted::new("?0", "?1", (4,0,0,0,0).into(), (1,0,0,0,0).into(), pat("(typeOf (lam (typeOf (app (typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun (arrT ?n1 f32) (fun (arrT ?n1 ?d0) (arrT ?n1 f32))) (fun (arrT ?n1 f32) (fun (arrT ?n0 (arrT ?n1 ?d0)) (arrT ?n1 f32))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun (pairT f32 ?d0) f32) (fun (arrT ?n1 (pairT f32 ?d0)) (arrT ?n1 f32)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?1 (fun f32 (fun ?d0 f32))) (typeOf (app (typeOf fst (fun (pairT f32 ?d0) f32)) (typeOf %e0 (pairT f32 ?d0))) f32)) (fun ?d0 f32)) (typeOf (app (typeOf snd (fun (pairT f32 ?d0) ?d0)) (typeOf %e0 (pairT f32 ?d0))) ?d0)) f32)) (fun (pairT f32 ?d0) f32))) (fun (arrT ?n1 (pairT f32 ?d0)) (arrT ?n1 f32))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n1 f32) (fun (arrT ?n1 ?d0) (arrT ?n1 (pairT f32 ?d0))))) (typeOf %e1 (arrT ?n1 f32))) (fun (arrT ?n1 ?d0) (arrT ?n1 (pairT f32 ?d0)))) (typeOf %e0 (arrT ?n1 ?d0))) (arrT ?n1 (pairT f32 ?d0)))) (arrT ?n1 f32))) (fun (arrT ?n1 ?d0) (arrT ?n1 f32)))) (fun (arrT ?n1 f32) (fun (arrT ?n1 ?d0) (arrT ?n1 f32))))) (fun (arrT ?n1 f32) (fun (arrT ?n0 (arrT ?n1 ?d0)) (arrT ?n1 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?d0))) (arrT ?n1 f32))) (typeOf %e0 (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?d0))))) (arrT ?n1 f32))) (fun (arrT ?n0 (arrT ?n1 ?d0)) (arrT ?n1 f32))) (typeOf (app (typeOf transpose (fun (arrT ?n1 (arrT ?n0 ?d0)) (arrT ?n0 (arrT ?n1 ?d0)))) (typeOf (app (typeOf snd (fun (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?d0))) (arrT ?n1 (arrT ?n0 ?d0)))) (typeOf %e0 (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?d0))))) (arrT ?n1 (arrT ?n0 ?d0)))) (arrT ?n0 (arrT ?n1 ?d0)))) (arrT ?n1 f32))) (fun (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?d0))) (arrT ?n1 f32))) (typeOf (app (typeOf unzip (fun (arrT ?n1 (pairT f32 (arrT ?n0 ?d0))) (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?d0))))) (typeOf %e0 (arrT ?n1 (pairT f32 (arrT ?n0 ?d0))))) (pairT (arrT ?n1 f32) (arrT ?n1 (arrT ?n0 ?d0))))) (arrT ?n1 f32))) (fun (arrT ?n1 (pairT f32 (arrT ?n0 ?d0))) (arrT ?n1 f32)))"))) }),
rewrite!("lift-reduce-seq-3"; { RisePredicate::new(pat("(typeOf (app (typeOf map ?tAny43) (typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq ?tAny44) (typeOf ?0 (fun (arrT ?n0 ?d0) (fun (arrT ?n0 ?d1) (arrT ?n0 ?d0))))) ?tAny45) (typeOf (app (typeOf fst ?tAny46) (typeOf (app (typeOf unzip ?tAny47) (typeOf %e0 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1))))) (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1))))) (arrT ?n0 ?d0))) ?tAny48) (typeOf (app (typeOf transpose ?tAny49) (typeOf (app (typeOf snd ?tAny50) (typeOf (app (typeOf unzip ?tAny51) (typeOf %e0 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1))))) (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1))))) (arrT ?n0 (arrT ?n1 ?d1)))) (arrT ?n1 (arrT ?n0 ?d1)))) ?tAny52)) (fun (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1))) (arrT ?n0 ?d0)))) (fun (arrT ?n2 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1)))) (arrT ?n2 (arrT ?n0 ?d0))))")) } => { DTCheck::new(NotFreeIn::new("?0", 0, Shifted::new("?0", "?1", (3,0,0,0,0).into(), (1,0,0,0,0).into(), pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduceSeq (fun (fun (arrT ?n2 (arrT ?n0 ?d0)) (fun (arrT ?n2 (arrT ?n0 ?d1)) (arrT ?n2 (arrT ?n0 ?d0)))) (fun (arrT ?n2 (arrT ?n0 ?d0)) (fun (arrT ?n1 (arrT ?n2 (arrT ?n0 ?d1))) (arrT ?n2 (arrT ?n0 ?d0)))))) (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1)) (arrT ?n0 ?d0)) (fun (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1))) (arrT ?n2 (arrT ?n0 ?d0))))) (typeOf (lam (typeOf (app (typeOf (app (typeOf ?1 (fun (arrT ?n0 ?d0) (fun (arrT ?n0 ?d1) (arrT ?n0 ?d0)))) (typeOf (app (typeOf fst (fun (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1)) (arrT ?n0 ?d0))) (typeOf %e0 (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1)))) (arrT ?n0 ?d0))) (fun (arrT ?n0 ?d1) (arrT ?n0 ?d0))) (typeOf (app (typeOf snd (fun (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1)) (arrT ?n0 ?d1))) (typeOf %e0 (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1)))) (arrT ?n0 ?d1))) (arrT ?n0 ?d0))) (fun (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1)) (arrT ?n0 ?d0)))) (fun (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1))) (arrT ?n2 (arrT ?n0 ?d0)))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n2 (arrT ?n0 ?d0)) (fun (arrT ?n2 (arrT ?n0 ?d1)) (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1)))))) (typeOf %e1 (arrT ?n2 (arrT ?n0 ?d0)))) (fun (arrT ?n2 (arrT ?n0 ?d1)) (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1))))) (typeOf %e0 (arrT ?n2 (arrT ?n0 ?d1)))) (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 ?d1))))) (arrT ?n2 (arrT ?n0 ?d0)))) (fun (arrT ?n2 (arrT ?n0 ?d1)) (arrT ?n2 (arrT ?n0 ?d0))))) (fun (arrT ?n2 (arrT ?n0 ?d0)) (fun (arrT ?n2 (arrT ?n0 ?d1)) (arrT ?n2 (arrT ?n0 ?d0)))))) (fun (arrT ?n2 (arrT ?n0 ?d0)) (fun (arrT ?n1 (arrT ?n2 (arrT ?n0 ?d1))) (arrT ?n2 (arrT ?n0 ?d0))))) (typeOf (app (typeOf fst (fun (pairT (arrT ?n2 (arrT ?n0 ?d0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1)))) (arrT ?n2 (arrT ?n0 ?d0)))) (typeOf (app (typeOf unzip (fun (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))) (pairT (arrT ?n2 (arrT ?n0 ?d0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1))) (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))) (fun (arrT ?n2 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1)))) (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1))))))) (typeOf unzip (fun (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1))) (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))))) (fun (arrT ?n2 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1)))) (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))))) (typeOf %e0 (arrT ?n2 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1)))))) (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))))) (pairT (arrT ?n2 (arrT ?n0 ?d0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1)))))) (arrT ?n2 (arrT ?n0 ?d0)))) (fun (arrT ?n1 (arrT ?n2 (arrT ?n0 ?d1))) (arrT ?n2 (arrT ?n0 ?d0)))) (typeOf (app (typeOf transpose (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1))) (arrT ?n1 (arrT ?n2 (arrT ?n0 ?d1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (arrT ?n1 ?d1)) (arrT ?n1 (arrT ?n0 ?d1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1)))))) (typeOf transpose (fun (arrT ?n0 (arrT ?n1 ?d1)) (arrT ?n1 (arrT ?n0 ?d1))))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1))))) (typeOf (app (typeOf snd (fun (pairT (arrT ?n2 (arrT ?n0 ?d0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1)))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1))))) (typeOf (app (typeOf unzip (fun (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))) (pairT (arrT ?n2 (arrT ?n0 ?d0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1)))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1))) (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))) (fun (arrT ?n2 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1)))) (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1))))))) (typeOf unzip (fun (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1))) (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))))) (fun (arrT ?n2 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1)))) (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))))) (typeOf %e0 (arrT ?n2 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1)))))) (arrT ?n2 (pairT (arrT ?n0 ?d0) (arrT ?n0 (arrT ?n1 ?d1)))))) (pairT (arrT ?n2 (arrT ?n0 ?d0)) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1)))))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1))))) (arrT ?n1 (arrT ?n2 (arrT ?n0 ?d1))))) (arrT ?n2 (arrT ?n0 ?d0)))) (fun (arrT ?n2 (arrT ?n0 (pairT ?d0 (arrT ?n1 ?d1)))) (arrT ?n2 (arrT ?n0 ?d0))))")))) }),
rewrite!("transpose-around-map-map-f-1m"; { RisePredicate::new(pat("(typeOf (app (typeOf (app (typeOf map ?tAny53) (typeOf (app (typeOf map ?tAny54) (typeOf (app (typeOf map ?tAny55) (typeOf ?0 (fun ?d0 ?d1))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1)))) (fun (arrT ?n1 (arrT ?n0 ?d0)) (arrT ?n1 (arrT ?n0 ?d1))))) ?tAny56) (typeOf ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d0))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1))))")) } => { DTCheck::new(pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (arrT ?n1 ?d1)) (arrT ?n1 (arrT ?n0 ?d1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1)))))) (typeOf transpose (fun (arrT ?n0 (arrT ?n1 ?d1)) (arrT ?n1 (arrT ?n0 ?d1))))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n0 (arrT ?n1 ?d0)) (arrT ?n0 (arrT ?n1 ?d1))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1)))))) (typeOf (app (typeOf map (fun (fun (arrT ?n1 ?d0) (arrT ?n1 ?d1)) (fun (arrT ?n0 (arrT ?n1 ?d0)) (arrT ?n0 (arrT ?n1 ?d1))))) (typeOf (app (typeOf map (fun (fun ?d0 ?d1) (fun (arrT ?n1 ?d0) (arrT ?n1 ?d1)))) (typeOf ?0 (fun ?d0 ?d1))) (fun (arrT ?n1 ?d0) (arrT ?n1 ?d1)))) (fun (arrT ?n0 (arrT ?n1 ?d0)) (arrT ?n0 (arrT ?n1 ?d1))))) (fun (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1))))) (typeOf (app (typeOf (app (typeOf map (fun (fun (arrT ?n1 (arrT ?n0 ?d0)) (arrT ?n0 (arrT ?n1 ?d0))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d0)))))) (typeOf transpose (fun (arrT ?n1 (arrT ?n0 ?d0)) (arrT ?n0 (arrT ?n1 ?d0))))) (fun (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d0))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d0))))) (typeOf ?1 (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d0))))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d0))))) (arrT ?n2 (arrT ?n0 (arrT ?n1 ?d1))))) (arrT ?n2 (arrT ?n1 (arrT ?n0 ?d1))))")) }),
rewrite!("store-to-mem"; { RisePredicate::new(pat("(typeOf ?0 ?d0)")) } => { DTCheck::new(pat("(typeOf (app (typeOf (app (typeOf let (fun ?d0 (fun (fun ?d0 ?d0) ?d0))) (typeOf (app (typeOf toMem (fun ?d0 ?d0)) (typeOf ?0 ?d0)) ?d0)) (fun (fun ?d0 ?d0) ?d0)) (typeOf (lam (typeOf %e0 ?d0)) (fun ?d0 ?d0))) ?d0)")) }),
rewrite!("map-array"; { RisePredicate::new(pat("(typeOf ?0 (arrT ?n0 ?d0))")) } => { DTCheck::new(pat("(typeOf (app (typeOf (app (typeOf map (fun (fun ?d0 ?d0) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d0)))) (typeOf (lam (typeOf %e0 ?d0)) (fun ?d0 ?d0))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d0))) (typeOf ?0 (arrT ?n0 ?d0))) (arrT ?n0 ?d0))")) }),
rewrite!("map-fusion"; { RisePredicate::new(pat("(typeOf (app (typeOf (app (typeOf map ?tAny57) (typeOf ?0 (fun ?d0 ?d1))) ?tAny58) (typeOf (app (typeOf (app (typeOf map ?tAny59) (typeOf ?1 (fun ?d2 ?d0))) ?tAny60) (typeOf ?2 (arrT ?n0 ?d2))) (arrT ?n0 ?d0))) (arrT ?n0 ?d1))")) } => { DTCheck::new(Shifted::new("?1", "?4", (1,0,0,0,0).into(), (0,0,0,0,0).into(), Shifted::new("?0", "?3", (1,0,0,0,0).into(), (0,0,0,0,0).into(), pat("(typeOf (app (typeOf (app (typeOf map (fun (fun ?d2 ?d1) (fun (arrT ?n0 ?d2) (arrT ?n0 ?d1)))) (typeOf (lam (typeOf (app (typeOf ?3 (fun ?d0 ?d1)) (typeOf (app (typeOf ?4 (fun ?d2 ?d0)) (typeOf %e0 ?d2)) ?d0)) ?d1)) (fun ?d2 ?d1))) (fun (arrT ?n0 ?d2) (arrT ?n0 ?d1))) (typeOf ?2 (arrT ?n0 ?d2))) (arrT ?n0 ?d1))")))) }),
rewrite!("map-eta-abstraction"; { RisePredicate::new(pat("(typeOf (app (typeOf map ?tAny61) (typeOf ?0 (fun ?d0 ?d1))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1)))")) } => { DTCheck::new(Shifted::new("?0", "?1", (1,0,0,0,0).into(), (0,0,0,0,0).into(), pat("(typeOf (lam (typeOf (app (typeOf (app (typeOf map (fun (fun ?d0 ?d1) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1)))) (typeOf ?1 (fun ?d0 ?d1))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1))) (typeOf %e0 (arrT ?n0 ?d0))) (arrT ?n0 ?d1))) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1)))"))) }),
rewrite!("vec-32-after-f32"; { RisePredicate::new(pat("(typeOf ?0 (arrT ?n0 f32))")) } => { DTCheck::new(Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), pat("(typeOf (app (typeOf asScalar (fun (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n f32)) (arrT ?n0 f32))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n1)) f32) (arrT (natMul (natPow 32n -1n) ?n1) (vecT %n0 f32))))) 32n) (fun (arrT ?n0 f32) (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n f32)))) (typeOf ?0 (arrT ?n0 f32))) (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n f32)))) (arrT ?n0 f32))"))) }),
rewrite!("vec-32-after-(f32, f32)"; { RisePredicate::new(pat("(typeOf ?0 (arrT ?n0 (pairT f32 f32)))")) } => { DTCheck::new(Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), pat("(typeOf (app (typeOf asScalar (fun (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 f32))) (arrT ?n0 (pairT f32 f32)))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n1)) (pairT f32 f32)) (arrT (natMul (natPow 32n -1n) ?n1) (vecT %n0 (pairT f32 f32)))))) 32n) (fun (arrT ?n0 (pairT f32 f32)) (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 f32))))) (typeOf ?0 (arrT ?n0 (pairT f32 f32)))) (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 f32))))) (arrT ?n0 (pairT f32 f32)))"))) }),
rewrite!("vec-32-after-(f32, (f32, f32))"; { RisePredicate::new(pat("(typeOf ?0 (arrT ?n0 (pairT f32 (pairT f32 f32))))")) } => { DTCheck::new(Shifted::new("?n0", "?n1", (1,0).into(), (0,0).into(), pat("(typeOf (app (typeOf asScalar (fun (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 (pairT f32 f32)))) (arrT ?n0 (pairT f32 (pairT f32 f32))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 (natMul (natPow 32n -1n) ?n1)) (pairT f32 (pairT f32 f32))) (arrT (natMul (natPow 32n -1n) ?n1) (vecT %n0 (pairT f32 (pairT f32 f32))))))) 32n) (fun (arrT ?n0 (pairT f32 (pairT f32 f32))) (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 (pairT f32 f32)))))) (typeOf ?0 (arrT ?n0 (pairT f32 (pairT f32 f32))))) (arrT (natMul (natPow 32n -1n) ?n0) (vecT 32n (pairT f32 (pairT f32 f32)))))) (arrT ?n0 (pairT f32 (pairT f32 f32))))"))) }),
rewrite!("vec-before-map-f32"; { RisePredicate::new(pat("(typeOf (app (typeOf (natApp (typeOf asVector ?tAny62) ?n0) ?tAny63) (typeOf (app (typeOf (app (typeOf map ?tAny64) (typeOf ?0 (fun f32 f32))) ?tAny65) (typeOf ?1 (arrT ?n1 f32))) (arrT ?n2 f32))) (arrT ?n3 (vecT ?n0 f32)))")) } => { DTCheck::new(VectorizeScalarFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", (1,0).into(), (0,0).into(), ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (vecT ?n0 f32) (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (vecT ?n0 f32))))) (typeOf ?2 (fun (vecT ?n0 f32) (vecT ?n0 f32)))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf ?1 (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32)))")))))) }),
rewrite!("vec-before-map-f32xf32"; { RisePredicate::new(pat("(typeOf (app (typeOf (natApp (typeOf asVector ?tAny66) ?n0) ?tAny67) (typeOf (app (typeOf (app (typeOf map ?tAny68) (typeOf ?0 (fun (pairT f32 f32) f32))) ?tAny69) (typeOf ?1 (arrT ?n1 (pairT f32 f32)))) (arrT ?n2 f32))) (arrT ?n3 (vecT ?n0 f32)))")) } => { DTCheck::new(VectorizeScalarFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", (1,0).into(), (0,0).into(), ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (pairT (vecT ?n0 f32) (vecT ?n0 f32)) (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (vecT ?n0 f32))))) (typeOf ?2 (fun (pairT (vecT ?n0 f32) (vecT ?n0 f32)) (vecT ?n0 f32)))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (arrT ?n3 (vecT ?n0 f32)))")))))) }),
rewrite!("vec-before-map-f32x-f32xf32"; { RisePredicate::new(pat("(typeOf (app (typeOf (natApp (typeOf asVector ?tAny70) ?n0) ?tAny71) (typeOf (app (typeOf (app (typeOf map ?tAny72) (typeOf ?0 (fun (pairT f32 (pairT f32 f32)) f32))) ?tAny73) (typeOf ?1 (arrT ?n1 (pairT f32 (pairT f32 f32))))) (arrT ?n2 f32))) (arrT ?n3 (vecT ?n0 f32)))")) } => { DTCheck::new(VectorizeScalarFun::new("?0", "?n0", "?2", Shifted::new("?n3", "?n4", (1,0).into(), (0,0).into(), ComputeNatCheck::new("?n1", "(natMul ?n3 ?n0)", ComputeNatCheck::new("?n2", "(natMul ?n3 ?n0)", pat("(typeOf (app (typeOf (app (typeOf map (fun (fun (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32))))) (typeOf ?2 (fun (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (vecT ?n0 f32)))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32))))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (fun (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (typeOf (app (typeOf (app (typeOf zip (fun (arrT ?n3 (vecT ?n0 f32)) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf fst (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (fun (arrT ?n3 (vecT ?n0 f32)) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (typeOf (app (typeOf (natApp (typeOf asVector (natFun (fun (arrT (natMul %n0 ?n4) f32) (arrT ?n4 (vecT %n0 f32))))) ?n0) (fun (arrT (natMul ?n3 ?n0) f32) (arrT ?n3 (vecT ?n0 f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)) (arrT (natMul ?n3 ?n0) f32))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 f32)) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (typeOf (app (typeOf snd (fun (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (typeOf (app (typeOf unzip (fun (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (typeOf ?1 (arrT (natMul ?n3 ?n0) (pairT f32 (pairT f32 f32))))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) (pairT f32 f32))))) (arrT (natMul ?n3 ?n0) (pairT f32 f32)))) (pairT (arrT (natMul ?n3 ?n0) f32) (arrT (natMul ?n3 ?n0) f32)))) (arrT (natMul ?n3 ?n0) f32))) (arrT ?n3 (vecT ?n0 f32)))) (arrT ?n3 (pairT (vecT ?n0 f32) (vecT ?n0 f32))))) (arrT ?n3 (pairT (vecT ?n0 f32) (pairT (vecT ?n0 f32) (vecT ?n0 f32)))))) (arrT ?n3 (vecT ?n0 f32)))")))))) }),
rewrite!("reduce-seq-unroll"; { RisePredicate::new(pat("(typeOf reduceSeq (fun (fun ?d0 (fun ?d1 ?d0)) (fun ?d0 (fun (arrT ?n0 ?d1) ?d0))))")) } => { DTCheck::new(pat("(typeOf reduceSeqUnroll (fun (fun ?d0 (fun ?d1 ?d0)) (fun ?d0 (fun (arrT ?n0 ?d1) ?d0))))")) }),
rewrite!("map-par"; { RisePredicate::new(pat("(typeOf map (fun (fun ?d0 ?d1) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1))))")) } => { DTCheck::new(pat("(typeOf mapPar (fun (fun ?d0 ?d1) (fun (arrT ?n0 ?d0) (arrT ?n0 ?d1))))")) }),



].into_iter().filter(|r|allowed_rules.contains(&r.name.as_str())).chain([
            rewrite!("eta-reduction"; { RisePredicate::new(pat("(typeOf (lam (typeOf (app (typeOf ?0 ?tAny0) (typeOf %e0 ?t0)) ?tAny1)) (fun ?t0 ?t1))")) } => { DTCheck::new(NotFreeIn::new("?0", 0, Shifted::new("?0", "?1", (-1,0,0,0,0).into(), (1,0,0,0,0).into(), pat("(typeOf ?1 (fun ?t0 ?t1))")))) }),
            // // OLD: rewrite!("beta"; { RisePredicate::new(pat("(app (lam ?body) ?e)")) } => { BetaExtractApplier::new("?body", "?e") }),
            rewrite!("beta"; { RisePredicate::new(pat("(app (typeOf (lam (typeOf ?body ?bodyTy)) ?lamTy) (typeOf ?subs ?subsTy))")) } => { BetaExtractApplier::new("?body", "?subs", Kind::Expr) }),
            // // Nat expr, type expr and addr expr have no type!
            // rewrite!("beta-nat"; { RisePredicate::new(pat("(natApp (typeOf (natLam (typeOf ?body ?bodyTy)) ?lamTy) ?subs)")) } => { BetaExtractApplier::new("?body", "?subs",Kind::Nat) }),
            // rewrite!("beta-data"; { RisePredicate::new(pat("(dataApp (typeOf (dataLam (typeOf ?body ?bodyTy)) ?lamTy) ?subs)")) } => { BetaExtractApplier::new("?body", "?subs",Kind::Data) }),
            // rewrite!("beta-addr"; { RisePredicate::new(pat("(addrApp (typeOf (addrLam (typeOf ?body ?bodyTy)) ?lamTy) ?subs)")) } => { BetaExtractApplier::new("?body", "?subs",Kind::Addr) }),
            //  // rewrite!("beta-nat-nat"; { RisePredicate::new(pat("(natNatApp (typeOf (natNatLam (typeOf ?body ?bodyTy)) ?lamTy) (typeOf ?subs ?subsTy))")) } => { BetaExtractApplier::new("?body", "?subs") }),
     ]).collect()
}

pub fn pat(pat: &str) -> Pattern<Rise> {
    pat.parse::<Pattern<Rise>>().unwrap()
}
